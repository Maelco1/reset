<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Espace Médecin - Gestion des gardes</title>
    <link rel="stylesheet" href="assets/css/styles.css" />
  </head>
  <body>
    <div id="connection-modal" class="modal-backdrop hidden" role="dialog" aria-modal="true">
      <section class="modal">
        <h1>Connexion à Supabase</h1>
        <p>Indiquez vos paramètres Supabase pour enregistrer vos gardes.</p>
        <form id="connection-form" class="card">
          <label for="supabaseUrl">URL Supabase</label>
          <input id="supabaseUrl" name="supabaseUrl" type="url" required />

          <label for="supabaseKey">Clé API</label>
          <input id="supabaseKey" name="supabaseKey" type="password" required />

          <div class="stack" style="justify-content: flex-end;">
            <button type="submit">Se connecter</button>
          </div>
        </form>
      </section>
    </div>
    <main>
      <section class="card">
        <header>
          <div>
            <h1>Espace Médecin</h1>
            <p>Déclarez vos gardes et disponibilités.</p>
          </div>
          <nav>
            <button id="disconnect" class="secondary" type="button">Changer d'instance</button>
            <button id="logout" class="secondary" type="button">Se déconnecter</button>
          </nav>
        </header>
        <section>
          <h2>Nouvelle garde</h2>
          <form id="guard-form">
            <label for="guard-date">Date</label>
            <input id="guard-date" name="date" type="date" required />

            <label for="guard-type">Type de garde</label>
            <select id="guard-type" name="type" required>
              <option value="Jour">Jour</option>
              <option value="Nuit">Nuit</option>
              <option value="Week-end">Week-end</option>
            </select>

            <label for="guard-notes">Notes</label>
            <textarea id="guard-notes" name="notes" rows="3" placeholder="Informations complémentaires"></textarea>

            <button type="submit">Enregistrer la garde</button>
            <p id="guard-feedback" role="status"></p>
          </form>
        </section>
        <section>
          <h2>Mes gardes</h2>
          <div class="card">
            <table class="table">
              <thead>
                <tr id="guards-header-row"></tr>
              </thead>
              <tbody id="guards-body"></tbody>
            </table>
            <p id="guards-feedback" role="status"></p>
          </div>
        </section>
      </section>
    </main>
    <script type="module">
      import {
        initializeConnectionModal,
        requireRole,
        getCurrentUser,
        setCurrentUser,
        getSupabaseClient,
        onSupabaseReady
      } from './js/supabaseClient.js';

      const user = getCurrentUser();
      if (!user) {
        window.location.replace('index.html');
      }
      requireRole('medecin');

      initializeConnectionModal();

      document.querySelector('#logout').addEventListener('click', () => {
        setCurrentUser(null);
        window.location.replace('index.html');
      });

      const form = document.querySelector('#guard-form');
      const feedback = document.querySelector('#guard-feedback');
      const tableBody = document.querySelector('#guards-body');
      const tableHeaderRow = document.querySelector('#guards-header-row');
      const listFeedback = document.querySelector('#guards-feedback');
      let channel;

      const formatDate = (value) => new Intl.DateTimeFormat('fr-FR').format(new Date(value));

      const DEFAULT_GUARD_TYPES = ['Jour', 'Nuit', 'Week-end'];

      const sortGuardTypes = (types) =>
        [...types].sort((a, b) => {
          const indexA = DEFAULT_GUARD_TYPES.indexOf(a);
          const indexB = DEFAULT_GUARD_TYPES.indexOf(b);
          if (indexA === -1 && indexB === -1) {
            return a.localeCompare(b);
          }
          if (indexA === -1) {
            return 1;
          }
          if (indexB === -1) {
            return -1;
          }
          return indexA - indexB;
        });

      const updateGuardHeader = (types) => {
        if (!tableHeaderRow) {
          return;
        }
        tableHeaderRow.innerHTML = '';
        const dateHeader = document.createElement('th');
        dateHeader.scope = 'col';
        dateHeader.textContent = 'Date';
        tableHeaderRow.appendChild(dateHeader);
        types.forEach((type) => {
          const th = document.createElement('th');
          th.scope = 'col';
          th.textContent = type;
          tableHeaderRow.appendChild(th);
        });
      };

      updateGuardHeader(DEFAULT_GUARD_TYPES);

      const renderGuards = (guards) => {
        tableBody.innerHTML = '';
        const typeSet = new Set(DEFAULT_GUARD_TYPES);
        guards.forEach((guard) => {
          if (guard.type) {
            typeSet.add(guard.type);
          }
        });
        const orderedTypes = sortGuardTypes(typeSet);
        updateGuardHeader(orderedTypes);

        if (!guards.length) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = orderedTypes.length + 1;
          cell.className = 'guards-empty-cell';
          cell.textContent = 'Aucune garde enregistrée.';
          row.appendChild(cell);
          tableBody.appendChild(row);
          return;
        }

        const groupedByDate = new Map();
        guards.forEach((guard) => {
          const key = guard.date;
          if (!groupedByDate.has(key)) {
            groupedByDate.set(key, new Map());
          }
          groupedByDate.get(key).set(guard.type, guard);
        });

        const sortedDates = [...groupedByDate.keys()].sort((a, b) => new Date(a) - new Date(b));

        sortedDates.forEach((dateKey) => {
          const row = document.createElement('tr');
          const dateHeader = document.createElement('th');
          dateHeader.scope = 'row';
          dateHeader.textContent = formatDate(dateKey);
          row.appendChild(dateHeader);

          const guardsByType = groupedByDate.get(dateKey);
          orderedTypes.forEach((type) => {
            const cell = document.createElement('td');
            const entry = guardsByType.get(type);
            if (entry) {
              const wrapper = document.createElement('div');
              wrapper.className = 'guard-cell';

              const badge = document.createElement('span');
              badge.className = 'badge';
              badge.textContent = entry.type;
              wrapper.appendChild(badge);

              const note = document.createElement('p');
              note.className = 'guard-note';
              note.textContent = entry.notes?.trim() || '—';
              wrapper.appendChild(note);

              const actions = document.createElement('div');
              actions.className = 'table-actions';
              const deleteButton = document.createElement('button');
              deleteButton.type = 'button';
              deleteButton.className = 'danger';
              deleteButton.dataset.action = 'delete';
              deleteButton.dataset.id = entry.id;
              deleteButton.textContent = 'Supprimer';
              actions.appendChild(deleteButton);
              wrapper.appendChild(actions);

              cell.appendChild(wrapper);
            } else {
              cell.className = 'guard-empty-cell';
              cell.textContent = '—';
            }
            row.appendChild(cell);
          });

          tableBody.appendChild(row);
        });
      };

      const loadGuards = async () => {
        await onSupabaseReady();
        const supabase = getSupabaseClient();
        const { data, error } = await supabase
          .from('doctor_entries')
          .select('id, date, type, notes')
          .eq('user_id', user.id)
          .order('date', { ascending: true });
        if (error) {
          console.error(error);
          listFeedback.textContent = 'Impossible de récupérer vos gardes.';
          return;
        }
        listFeedback.textContent = `${data.length} garde(s).`;
        renderGuards(data);
      };

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        await onSupabaseReady();
        const supabase = getSupabaseClient();
        const formData = new FormData(form);
        const payload = {
          user_id: user.id,
          date: formData.get('date'),
          type: formData.get('type'),
          notes: formData.get('notes')?.trim() || null
        };

        const { error } = await supabase.from('doctor_entries').insert(payload);
        if (error) {
          console.error(error);
          feedback.textContent = "Impossible d'enregistrer la garde.";
          return;
        }

        feedback.textContent = 'Garde enregistrée !';
        form.reset();
      });

      tableBody.addEventListener('click', async (event) => {
        const button = event.target.closest('button');
        if (!button) {
          return;
        }
        if (button.dataset.action === 'delete') {
          if (!confirm('Supprimer cette garde ?')) {
            return;
          }
          await onSupabaseReady();
          const supabase = getSupabaseClient();
          const { error } = await supabase.from('doctor_entries').delete().eq('id', button.dataset.id);
          if (error) {
            console.error(error);
            alert('Impossible de supprimer la garde.');
          }
        }
      });

      const subscribe = async () => {
        await onSupabaseReady();
        const supabase = getSupabaseClient();
        channel = supabase
          .channel('doctor-entries')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'doctor_entries', filter: `user_id=eq.${user.id}` }, () => {
            loadGuards();
          })
          .subscribe();
      };

      loadGuards();
      subscribe();

      window.addEventListener('beforeunload', () => {
        channel?.unsubscribe();
      });
    </script>
  </body>
</html>
