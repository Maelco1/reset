<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Espace Médecin - Gestion des gardes</title>
    <link rel="stylesheet" href="assets/css/styles.css" />
  </head>
  <body>
    <div id="connection-modal" class="modal-backdrop hidden" role="dialog" aria-modal="true">
      <section class="modal">
        <h1>Connexion à Supabase</h1>
        <p>Indiquez vos paramètres Supabase pour enregistrer vos gardes.</p>
        <form id="connection-form" class="card">
          <label for="supabaseUrl">URL Supabase</label>
          <input id="supabaseUrl" name="supabaseUrl" type="url" required />

          <label for="supabaseKey">Clé API</label>
          <input id="supabaseKey" name="supabaseKey" type="password" required />

          <div class="stack" style="justify-content: flex-end;">
            <button type="submit">Se connecter</button>
          </div>
        </form>
      </section>
    </div>
    <main>
      <section class="card">
        <header>
          <div>
            <h1>Espace Médecin</h1>
            <p>Déclarez vos gardes et disponibilités.</p>
          </div>
          <nav>
            <button id="disconnect" class="secondary" type="button">Changer d'instance</button>
            <button id="logout" class="secondary" type="button">Se déconnecter</button>
          </nav>
        </header>
        <section>
          <h2>Nouvelle garde</h2>
          <form id="guard-form">
            <label for="guard-date">Date</label>
            <input id="guard-date" name="date" type="date" required />

            <label for="guard-type">Type de garde</label>
            <select id="guard-type" name="type" required>
              <option value="Jour">Jour</option>
              <option value="Nuit">Nuit</option>
              <option value="Week-end">Week-end</option>
            </select>

            <label for="guard-notes">Notes</label>
            <textarea id="guard-notes" name="notes" rows="3" placeholder="Informations complémentaires"></textarea>

            <button type="submit">Enregistrer la garde</button>
            <p id="guard-feedback" role="status"></p>
          </form>
        </section>
        <section>
          <h2>Mes gardes</h2>
          <div class="card">
            <table class="table guards-table">
              <thead>
                <tr id="guards-header-row"></tr>
              </thead>
              <tbody id="guards-body"></tbody>
            </table>
            <p id="guards-feedback" role="status"></p>
          </div>
        </section>
      </section>
    </main>
    <script type="module">
      import {
        initializeConnectionModal,
        requireRole,
        getCurrentUser,
        setCurrentUser,
        getSupabaseClient,
        onSupabaseReady
      } from './js/supabaseClient.js';

      const user = getCurrentUser();
      if (!user) {
        window.location.replace('index.html');
      }
      requireRole('medecin');

      initializeConnectionModal();

      document.querySelector('#logout').addEventListener('click', () => {
        setCurrentUser(null);
        window.location.replace('index.html');
      });

      const form = document.querySelector('#guard-form');
      const feedback = document.querySelector('#guard-feedback');
      const tableBody = document.querySelector('#guards-body');
      const tableHeaderRow = document.querySelector('#guards-header-row');
      const listFeedback = document.querySelector('#guards-feedback');
      let channel;

      const formatDate = (value) => new Intl.DateTimeFormat('fr-FR').format(new Date(value));

      const updateGuardHeader = () => {
        if (!tableHeaderRow) {
          return;
        }
        tableHeaderRow.innerHTML = '';
        const headers = [
          { key: 'date', label: 'Date' },
          { key: 'type', label: 'Type' },
          { key: 'notes', label: 'Notes' },
          { key: 'actions', label: 'Actions' }
        ];
        headers.forEach((header) => {
          const th = document.createElement('th');
          th.scope = 'col';
          th.dataset.column = header.key;
          th.textContent = header.label;
          tableHeaderRow.appendChild(th);
        });
      };

      updateGuardHeader();

      const renderGuards = (guards) => {
        tableBody.innerHTML = '';
        updateGuardHeader();

        if (!guards.length) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 4;
          cell.className = 'guards-empty-cell';
          cell.textContent = 'Aucune garde enregistrée.';
          row.appendChild(cell);
          tableBody.appendChild(row);
          return;
        }

        const sortedGuards = [...guards].sort((a, b) => {
          const dateDiff = new Date(a.date) - new Date(b.date);
          if (dateDiff !== 0) {
            return dateDiff;
          }
          const typeA = a.type ?? '';
          const typeB = b.type ?? '';
          return typeA.localeCompare(typeB);
        });

        sortedGuards.forEach((guard) => {
          const row = document.createElement('tr');

          const dateCell = document.createElement('th');
          dateCell.scope = 'row';
          dateCell.textContent = formatDate(guard.date);
          row.appendChild(dateCell);

          const typeCell = document.createElement('td');
          typeCell.className = 'guard-type-cell';
          typeCell.textContent = guard.type || '—';
          row.appendChild(typeCell);

          const notesCell = document.createElement('td');
          notesCell.className = 'guard-notes-cell';
          notesCell.textContent = guard.notes?.trim() || '—';
          row.appendChild(notesCell);

          const actionsCell = document.createElement('td');
          actionsCell.className = 'guard-actions-cell';
          const deleteButton = document.createElement('button');
          deleteButton.type = 'button';
          deleteButton.className = 'danger';
          deleteButton.dataset.action = 'delete';
          deleteButton.dataset.id = guard.id;
          deleteButton.textContent = 'Supprimer';
          actionsCell.appendChild(deleteButton);
          row.appendChild(actionsCell);

          tableBody.appendChild(row);
        });
      };

      const loadGuards = async () => {
        await onSupabaseReady();
        const supabase = getSupabaseClient();
        const { data, error } = await supabase
          .from('doctor_entries')
          .select('id, date, type, notes')
          .eq('user_id', user.id)
          .order('date', { ascending: true });
        if (error) {
          console.error(error);
          listFeedback.textContent = 'Impossible de récupérer vos gardes.';
          return;
        }
        listFeedback.textContent = `${data.length} garde(s).`;
        renderGuards(data);
      };

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        await onSupabaseReady();
        const supabase = getSupabaseClient();
        const formData = new FormData(form);
        const payload = {
          user_id: user.id,
          date: formData.get('date'),
          type: formData.get('type'),
          notes: formData.get('notes')?.trim() || null
        };

        const { error } = await supabase.from('doctor_entries').insert(payload);
        if (error) {
          console.error(error);
          feedback.textContent = "Impossible d'enregistrer la garde.";
          return;
        }

        feedback.textContent = 'Garde enregistrée !';
        form.reset();
      });

      tableBody.addEventListener('click', async (event) => {
        const button = event.target.closest('button');
        if (!button) {
          return;
        }
        if (button.dataset.action === 'delete') {
          if (!confirm('Supprimer cette garde ?')) {
            return;
          }
          await onSupabaseReady();
          const supabase = getSupabaseClient();
          const { error } = await supabase.from('doctor_entries').delete().eq('id', button.dataset.id);
          if (error) {
            console.error(error);
            alert('Impossible de supprimer la garde.');
          }
        }
      });

      const subscribe = async () => {
        await onSupabaseReady();
        const supabase = getSupabaseClient();
        channel = supabase
          .channel('doctor-entries')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'doctor_entries', filter: `user_id=eq.${user.id}` }, () => {
            loadGuards();
          })
          .subscribe();
      };

      loadGuards();
      subscribe();

      window.addEventListener('beforeunload', () => {
        channel?.unsubscribe();
      });
    </script>
  </body>
</html>
