<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Administration - Gestion des gardes</title>
    <link rel="stylesheet" href="assets/css/styles.css" />
  </head>
  <body>
    <div id="connection-modal" class="modal-backdrop hidden" role="dialog" aria-modal="true">
      <section class="modal">
        <h1>Connexion à Supabase</h1>
        <p>Pour gérer les comptes, configurez l'accès à votre instance Supabase.</p>
        <form id="connection-form" class="card">
          <label for="supabaseUrl">URL Supabase</label>
          <input id="supabaseUrl" name="supabaseUrl" type="url" required />

          <label for="supabaseKey">Clé API</label>
          <input id="supabaseKey" name="supabaseKey" type="password" required />

          <div class="stack" style="justify-content: flex-end;">
            <button type="submit">Se connecter</button>
          </div>
        </form>
      </section>
    </div>
    <main>
      <section class="card admin-shell">
        <header>
          <div>
            <h1>Espace administrateur</h1>
            <p>Gérez les comptes grâce aux trigrammes de vos collaborateurs.</p>
          </div>
          <nav>
            <button id="open-admin-settings" type="button">Paramètres administrateur</button>
            <button id="disconnect" class="secondary" type="button">Changer d'instance</button>
            <button id="logout" class="secondary" type="button">Se déconnecter</button>
          </nav>
        </header>

        <section aria-labelledby="users-title" class="users-section">
          <div class="section-header">
            <h2 id="users-title">Comptes utilisateurs</h2>
            <p id="users-feedback" role="status"></p>
          </div>
          <div class="user-groups" id="user-groups"></div>
        </section>

        <section aria-labelledby="planning-title" class="planning-section">
          <div class="planning-surface">
            <div class="section-header planning-section-header">
              <h2 id="planning-title">Planning des gardes</h2>
              <p id="planning-feedback" role="status"></p>
            </div>

            <nav class="planning-tabs" id="planning-tour-tabs" role="tablist" aria-label="Tours du planning"></nav>

            <section id="planning-controls" class="planning-controls" aria-label="Paramètres du planning">
              <div class="planning-control">
                <span class="planning-control-label">Année</span>
                <span id="planning-year-display" class="planning-control-value">—</span>
              </div>

              <div class="planning-control">
                <span class="planning-control-label">Mois 1</span>
                <span id="planning-month-1-display" class="planning-control-value">—</span>
              </div>

              <div class="planning-control">
                <span class="planning-control-label">Mois 2</span>
                <span id="planning-month-2-display" class="planning-control-value">—</span>
              </div>

              <div class="planning-control planning-vision-control">
                <span class="planning-control-label">Vision</span>
                <div class="planning-vision-group" role="group" aria-label="Vision du planning">
                  <button
                    type="button"
                    id="planning-vision-mauvaise"
                    class="planning-vision-toggle"
                    aria-pressed="false"
                  >
                    Vision “Garde normale”
                  </button>
                  <button
                    type="button"
                    id="planning-vision-bonus"
                    class="planning-vision-toggle"
                    aria-pressed="false"
                  >
                    Vision “Bonne garde”
                  </button>
                </div>
              </div>
            </section>

            <div class="planning-layout">
              <div class="planning-board" id="planning-board" role="region" aria-labelledby="planning-title">
                <div class="planning-tables" id="planning-tables" aria-live="polite"></div>
              </div>
            </div>
          </div>
        </section>

        <footer class="admin-footer" aria-labelledby="create-title">
          <h2 id="create-title">Ajouter un utilisateur</h2>
          <p>Complétez les informations ci-dessous pour ajouter un nouveau compte.</p>
          <form id="create-user-form" class="compact-form">
            <div class="form-grid">
              <label for="new-username">Identifiant</label>
              <input id="new-username" name="username" type="text" autocomplete="off" required />

              <label for="new-trigram">Trigramme</label>
              <input
                id="new-trigram"
                name="trigram"
                type="text"
                inputmode="text"
                maxlength="3"
                autocomplete="off"
                required
                class="uppercase-input"
              />

              <label for="new-password">Mot de passe</label>
              <input id="new-password" name="password" type="password" autocomplete="new-password" required />

              <label for="new-role">Rôle</label>
              <select id="new-role" name="role" required>
                <option value="administrateur">Administrateur</option>
                <option value="medecin">Médecin</option>
                <option value="remplacant">Remplaçant</option>
              </select>
            </div>

            <button type="submit" class="subtle-button">Ajouter l'utilisateur</button>
            <p id="create-feedback" role="status"></p>
          </form>
        </footer>
      </section>
    </main>

    <div
      id="admin-settings-modal"
      class="modal-backdrop hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="admin-settings-title"
    >
      <section class="modal admin-settings-modal">
        <header class="modal-header">
          <div>
            <h2 id="admin-settings-title">Paramètres administrateur</h2>
            <p>Configurez les paramètres généraux de l'administration.</p>
          </div>
          <button type="button" class="icon-button" id="close-admin-settings-modal" aria-label="Fermer">
            &times;
          </button>
        </header>

        <form id="admin-settings-form" class="admin-settings-form">
          <fieldset class="admin-settings-fieldset">
            <legend>Planning en cours</legend>
            <div class="admin-settings-grid">
              <div class="admin-settings-field">
                <label for="active-tour-select">Tour actif</label>
                <select id="active-tour-select" name="activeTour">
                  <option value="">Aucun tour actif</option>
                  <option value="1">Tour 1</option>
                  <option value="2">Tour 2</option>
                  <option value="3">Tour 3</option>
                  <option value="4">Tour 4</option>
                  <option value="5">Tour 5</option>
                  <option value="6">Tour 6</option>
                </select>
              </div>

              <div class="admin-settings-field">
                <label for="planning-year">Année</label>
                <select id="planning-year" name="planningYear"></select>
              </div>

              <div class="admin-settings-field">
                <label for="planning-month-1">Mois 1</label>
                <select id="planning-month-1" name="planningMonthOne"></select>
              </div>

              <div class="admin-settings-field">
                <label for="planning-month-2">Mois 2</label>
                <select id="planning-month-2" name="planningMonthTwo"></select>
              </div>
            </div>
          </fieldset>

          <div class="admin-settings-notes">
            <label for="admin-instructions">Consignes / commentaires</label>
            <textarea
              id="admin-instructions"
              name="instructions"
              rows="5"
              placeholder="Ajouter des consignes pour le tour en cours"
            ></textarea>
          </div>

          <div class="admin-settings-footer">
            <p id="admin-settings-feedback" role="status"></p>
            <div class="admin-settings-actions">
              <button type="submit">Enregistrer</button>
              <button type="button" class="secondary" id="cancel-admin-settings">Fermer</button>
            </div>
          </div>
        </form>
      </section>
    </div>

    <div id="user-modal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="user-modal-title">
      <section class="modal user-modal">
        <header class="modal-header">
          <div>
            <h2 id="user-modal-title">Gérer l'utilisateur</h2>
            <p id="user-modal-subtitle"></p>
          </div>
          <button type="button" class="icon-button" id="close-user-modal" aria-label="Fermer">&times;</button>
        </header>
        <form id="edit-user-form">
          <input type="hidden" id="edit-user-id" name="id" />

          <label for="edit-username">Identifiant</label>
          <input id="edit-username" name="username" type="text" autocomplete="off" />

          <label for="edit-trigram">Trigramme</label>
          <input
            id="edit-trigram"
            name="trigram"
            type="text"
            maxlength="3"
            autocomplete="off"
            required
            class="uppercase-input"
          />

          <label for="edit-role">Rôle</label>
          <select id="edit-role" name="role" required>
            <option value="administrateur">Administrateur</option>
            <option value="medecin">Médecin</option>
            <option value="remplacant">Remplaçant</option>
          </select>

          <label for="edit-password">Nouveau mot de passe</label>
          <input id="edit-password" name="password" type="password" autocomplete="new-password" placeholder="Laisser vide pour ne pas changer" />

          <div class="modal-actions">
            <button type="submit">Enregistrer</button>
            <button type="button" id="delete-user" class="danger">Supprimer</button>
          </div>
        </form>
      </section>
    </div>

    <div id="slot-modal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="slot-modal-title">
      <section class="modal planning-modal">
        <header class="modal-header">
          <div>
            <h2 id="slot-modal-title">Configurer le créneau</h2>
            <p id="slot-modal-subtitle"></p>
          </div>
          <button type="button" class="icon-button" id="close-slot-modal" aria-label="Fermer">&times;</button>
        </header>

        <form id="slot-form">
          <input type="hidden" name="position" id="slot-position" />

          <div class="slot-grid">
            <div class="slot-field-group">
              <label for="slot-label">Nom de la colonne</label>
              <input id="slot-label" name="label" type="text" required />
            </div>

            <div class="slot-field-group">
              <label for="slot-type-code">Type de colonne (acronyme)</label>
              <input id="slot-type-code" name="typeCode" type="text" required />
            </div>

            <div class="slot-field-group">
              <label for="slot-type-category">Catégorie</label>
              <select id="slot-type-category" name="typeCategory" required>
                <option value="Visite">Visite</option>
                <option value="Consultation">Consultation</option>
                <option value="Téléconsultation">Téléconsultation</option>
              </select>
            </div>

            <div class="slot-field-group">
              <label for="slot-color">Couleur</label>
              <input id="slot-color" name="color" type="color" value="#1e293b" />
            </div>
          </div>

          <div class="slot-times">
            <div class="slot-field-group">
              <label for="slot-start">Début</label>
              <input id="slot-start" name="startTime" type="time" />
            </div>
            <div class="slot-field-group">
              <label for="slot-end">Fin</label>
              <input id="slot-end" name="endTime" type="time" />
            </div>
          </div>
          <fieldset class="slot-qualities">
            <legend>Qualité par période</legend>
            <div class="slot-qualities-grid">
              <label for="slot-quality-weekdays">Lun - Ven</label>
              <select id="slot-quality-weekdays" name="qualityWeekdays" required>
                <option value="Normale">Normale</option>
                <option value="Bonne">Bonne</option>
              </select>

              <label for="slot-quality-saturday">Samedi</label>
              <select id="slot-quality-saturday" name="qualitySaturday" required>
                <option value="Normale">Normale</option>
                <option value="Bonne">Bonne</option>
              </select>

              <label for="slot-quality-sunday">Dimanche / Férié</label>
              <select id="slot-quality-sunday" name="qualitySunday" required>
                <option value="Normale">Normale</option>
                <option value="Bonne">Bonne</option>
              </select>
            </div>
          </fieldset>

          <fieldset class="slot-openings">
            <legend>Ouverture des cases</legend>
            <div class="slot-openings-grid">
              <div>
                <h3>Normale</h3>
                <label for="slot-open-mauvaise-weekdays">Lun - Ven</label>
                <select id="slot-open-mauvaise-weekdays" name="openMauvaiseWeekdays" required>
                  <option value="true">Oui</option>
                  <option value="false">Non</option>
                </select>

                <label for="slot-open-mauvaise-saturday">Samedi</label>
                <select id="slot-open-mauvaise-saturday" name="openMauvaiseSaturday" required>
                  <option value="true">Oui</option>
                  <option value="false">Non</option>
                </select>

                <label for="slot-open-mauvaise-sunday">Dimanche / Férié</label>
                <select id="slot-open-mauvaise-sunday" name="openMauvaiseSunday" required>
                  <option value="true">Oui</option>
                  <option value="false">Non</option>
                </select>
              </div>
              <div>
                <h3>Bonne</h3>
                <label for="slot-open-bonus-weekdays">Lun - Ven</label>
                <select id="slot-open-bonus-weekdays" name="openBonusWeekdays" required>
                  <option value="true">Oui</option>
                  <option value="false">Non</option>
                </select>

                <label for="slot-open-bonus-saturday">Samedi</label>
                <select id="slot-open-bonus-saturday" name="openBonusSaturday" required>
                  <option value="true">Oui</option>
                  <option value="false">Non</option>
                </select>

                <label for="slot-open-bonus-sunday">Dimanche / Férié</label>
                <select id="slot-open-bonus-sunday" name="openBonusSunday" required>
                  <option value="true">Oui</option>
                  <option value="false">Non</option>
                </select>
              </div>
            </div>
          </fieldset>

          <div class="modal-actions">
            <button type="submit">Enregistrer</button>
            <button type="button" class="secondary" id="cancel-slot">Annuler</button>
          </div>
          <p id="slot-feedback" role="status"></p>
        </form>
      </section>
    </div>

    <div
      id="assignment-modal"
      class="modal-backdrop hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="assignment-modal-title"
    >
      <section class="modal planning-modal">
        <header class="modal-header">
          <div>
            <h2 id="assignment-modal-title">Attribuer la garde</h2>
            <p id="assignment-modal-subtitle"></p>
          </div>
          <button type="button" class="icon-button" id="close-assignment-modal" aria-label="Fermer">&times;</button>
        </header>

        <form id="assignment-form" class="assignment-form">
          <input type="hidden" name="slotKey" id="assignment-slot-key" />

          <label for="assignment-select">Sélectionner un médecin ou un remplaçant</label>
          <select id="assignment-select" name="userId" class="assignment-select"></select>

          <p id="assignment-feedback" role="status"></p>

          <div class="modal-actions">
            <button type="submit">Enregistrer</button>
            <button type="button" id="cancel-assignment" class="secondary">Annuler</button>
          </div>
        </form>
      </section>
    </div>

    <script type="module">
      import {
        initializeConnectionModal,
        requireRole,
        getCurrentUser,
        setCurrentUser,
        getSupabaseClient,
        onSupabaseReady,
        normalizeRole
      } from './js/supabaseClient.js';

      const DEFAULT_COLOR = '#1e293b';
      const DEFAULT_COLUMN_TINT = 'rgba(30, 41, 59, 0.12)';
      const COLUMN_DEFAULTS = [
        { position: 1, typeCode: '1N', color: '#1e293b' },
        { position: 2, typeCode: '2N', color: '#1e293b' },
        { position: 3, typeCode: '3N', color: '#1e293b' },
        { position: 4, typeCode: '4C', color: '#1e293b' },
        { position: 5, typeCode: '5S', color: '#1e293b' },
        { position: 6, typeCode: '6S', color: '#1e293b' },
        { position: 7, typeCode: 'VIS', color: '#1e293b' },
        { position: 8, typeCode: 'VIS', color: '#1e293b' },
        { position: 9, typeCode: 'VIS', color: '#1e293b' },
        { position: 10, typeCode: 'VIS', color: '#1e293b' },
        { position: 11, typeCode: 'VIS', color: '#1e293b' },
        { position: 12, typeCode: 'TC', color: '#1e293b' },
        { position: 13, typeCode: 'C1COU', color: '#1e293b' },
        { position: 14, typeCode: 'C2COU', color: '#1e293b' },
        { position: 15, typeCode: 'C1BOU', color: '#1e293b' },
        { position: 16, typeCode: 'C2BOU', color: '#1e293b' },
        { position: 17, typeCode: 'PFG', color: '#1e293b' },
        { position: 18, typeCode: 'C1ANT', color: '#1e293b' },
        { position: 19, typeCode: 'C2ANT', color: '#1e293b' },
        { position: 20, typeCode: 'TC', color: '#1e293b' },
        { position: 21, typeCode: 'N', color: '#1e293b' },
        { position: 22, typeCode: 'C', color: '#1e293b' },
        { position: 23, typeCode: 'S', color: '#1e293b' },
        { position: 24, typeCode: 'VIS', color: '#1e293b' },
        { position: 25, typeCode: 'VIS', color: '#1e293b' },
        { position: 26, typeCode: 'VIS', color: '#1e293b' },
        { position: 27, typeCode: 'C1COU', color: '#1e293b' },
        { position: 28, typeCode: 'C2COU', color: '#1e293b' },
        { position: 29, typeCode: 'C1BOU', color: '#1e293b' },
        { position: 30, typeCode: 'C2BOU', color: '#1e293b' },
        { position: 31, typeCode: 'PFG', color: '#1e293b' },
        { position: 32, typeCode: 'C1ANT', color: '#1e293b' },
        { position: 33, typeCode: 'C2ANT', color: '#1e293b' },
        { position: 34, typeCode: 'TC', color: '#1e293b' },
        { position: 35, typeCode: 'VIS', color: '#1e293b' },
        { position: 36, typeCode: 'PFG', color: '#1e293b' },
        { position: 37, typeCode: 'VIS', color: '#1e293b' },
        { position: 38, typeCode: 'VIS', color: '#1e293b' },
        { position: 39, typeCode: 'VIS', color: '#1e293b' },
        { position: 40, typeCode: 'VIS', color: '#1e293b' },
        { position: 41, typeCode: 'VIS', color: '#1e293b' },
        { position: 42, typeCode: 'VIS', color: '#1e293b' },
        { position: 43, typeCode: 'TCN', color: '#1e293b' },
        { position: 44, typeCode: 'VIS', color: '#1e293b' },
        { position: 45, typeCode: 'VIS', color: '#1e293b' },
        { position: 46, typeCode: 'VIS', color: '#1e293b' }
      ];
      const TYPE_CATEGORY_MAP = new Map([
        ...[
          '1N',
          '2N',
          '3N',
          '4C',
          '5S',
          '6S',
          'N',
          'C',
          'S',
          'VIS'
        ].map((code) => [code, 'Visite']),
        ...[
          'C1COU',
          'C2COU',
          'C1BOU',
          'C2BOU',
          'PFG',
          'C1ANT',
          'C2ANT',
          'C1',
          'C2',
          'C3'
        ].map((code) => [code, 'Consultation']),
        ...['TC', 'TCN'].map((code) => [code, 'Téléconsultation'])
      ]);

      const PLANNING_TOURS = [
        { id: 1, label: 'Tour 1', table: 'planning_columns' },
        { id: 2, label: 'Tour 2', table: 'planning_columns_tour2' },
        { id: 3, label: 'Tour 3', table: 'planning_columns_tour3' },
        { id: 4, label: 'Tour 4', table: 'planning_columns_tour4' },
        { id: 5, label: 'Tour 5', table: 'planning_columns_tour5' },
        { id: 6, label: 'Tour 6', table: 'planning_columns_tour6' }
      ];
      const ADMIN_SETTINGS_TABLE = 'parametres_administratifs';

      let selectedTourId = PLANNING_TOURS[0].id;

      const getTourConfig = (tourId = selectedTourId) =>
        PLANNING_TOURS.find((tour) => tour.id === tourId) ?? PLANNING_TOURS[0];

      const getPlanningTableName = (tourId = selectedTourId) => getTourConfig(tourId).table;
      const WEEKDAY_LABELS = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
      const MONTH_NAMES = [
        'Janvier',
        'Février',
        'Mars',
        'Avril',
        'Mai',
        'Juin',
        'Juillet',
        'Août',
        'Septembre',
        'Octobre',
        'Novembre',
        'Décembre'
      ];

      const ASSIGNMENT_ROLE_LABELS = {
        medecin: 'Médecin',
        remplacant: 'Remplaçant'
      };

      const MAX_PLANNING_CELL_WIDTH = 132;
      const MAX_PLANNING_CELL_HEIGHT = 88;

      const currentUser = getCurrentUser();
      if (!currentUser) {
        window.location.replace('index.html');
      }
      requireRole('administrateur');

      initializeConnectionModal();

      const logoutBtn = document.querySelector('#logout');
      logoutBtn.addEventListener('click', () => {
        setCurrentUser(null);
        window.location.replace('index.html');
      });

      const createForm = document.querySelector('#create-user-form');
      const createFeedback = document.querySelector('#create-feedback');
      const usersFeedback = document.querySelector('#users-feedback');
      const userGroups = document.querySelector('#user-groups');
      const userModal = document.querySelector('#user-modal');
      const userModalSubtitle = document.querySelector('#user-modal-subtitle');
      const editForm = document.querySelector('#edit-user-form');
      const deleteUserBtn = document.querySelector('#delete-user');
      const closeUserModalBtn = document.querySelector('#close-user-modal');
      const trigramInputs = document.querySelectorAll('.uppercase-input');

      const planningTourTabs = document.querySelector('#planning-tour-tabs');
      const planningYearSelect = document.querySelector('#planning-year');
      const planningMonthOneSelect = document.querySelector('#planning-month-1');
      const planningMonthTwoSelect = document.querySelector('#planning-month-2');
      const planningYearDisplay = document.querySelector('#planning-year-display');
      const planningMonthOneDisplay = document.querySelector('#planning-month-1-display');
      const planningMonthTwoDisplay = document.querySelector('#planning-month-2-display');
      const adminSettingsBtn = document.querySelector('#open-admin-settings');
      const adminSettingsModal = document.querySelector('#admin-settings-modal');
      const closeAdminSettingsBtn = document.querySelector('#close-admin-settings-modal');
      const cancelAdminSettingsBtn = document.querySelector('#cancel-admin-settings');
      const adminSettingsForm = document.querySelector('#admin-settings-form');
      const adminSettingsFeedback = document.querySelector('#admin-settings-feedback');
      const activeTourSelect = document.querySelector('#active-tour-select');
      const adminInstructionsField = document.querySelector('#admin-instructions');
      const planningConfigContainer = document.querySelector('#planning-config');
      const planningTables = document.querySelector('#planning-tables');
      const planningFeedback = document.querySelector('#planning-feedback');
      const planningVisionMauvaise = document.querySelector('#planning-vision-mauvaise');
      const planningVisionBonus = document.querySelector('#planning-vision-bonus');
      const planningVisionButtons = {
        mauvaise: planningVisionMauvaise,
        bonus: planningVisionBonus
      };

      let adminSettingsRecordId = null;
      let administrativeSettings = null;
      let planningCellSizingFrame = null;
      let planningStickyHeaderFrame = null;
      let activePlanningVision = null;

      const updatePlanningVisionButtons = () => {
        Object.entries(planningVisionButtons).forEach(([vision, button]) => {
          if (!button) {
            return;
          }
          const isActive = activePlanningVision === vision;
          button.classList.toggle('is-active', isActive);
          button.setAttribute('aria-pressed', String(isActive));
        });
      };

      const togglePlanningVision = (vision) => {
        const normalizedVision = vision === 'bonus' ? 'bonus' : vision === 'mauvaise' ? 'mauvaise' : null;
        activePlanningVision = activePlanningVision === normalizedVision ? null : normalizedVision;
        updatePlanningVisionButtons();
        renderPlanningTables();
      };

      const measurePlanningCellSize = () => {
        if (!planningTables) {
          return;
        }
        planningTables.style.removeProperty('--planning-cell-width');
        planningTables.style.removeProperty('--planning-cell-height');
        const widthElements = new Set([
          ...planningTables.querySelectorAll('.planning-slot-toggle'),
          ...planningTables.querySelectorAll('.planning-slot-button'),
          ...planningTables.querySelectorAll('.planning-slot-index')
        ]);
        const heightElements = new Set([
          ...planningTables.querySelectorAll('.planning-slot-toggle'),
          ...planningTables.querySelectorAll('.planning-slot-button')
        ]);
        if (!widthElements.size && !heightElements.size) {
          return;
        }
        let maxWidth = 0;
        let maxHeight = 0;
        widthElements.forEach((element) => {
          if (!element.isConnected) {
            return;
          }
          element.style.removeProperty('width');
          element.style.removeProperty('height');
          const rect = element.getBoundingClientRect();
          maxWidth = Math.max(maxWidth, rect.width);
        });
        heightElements.forEach((element) => {
          if (!element.isConnected) {
            return;
          }
          element.style.removeProperty('height');
          const rect = element.getBoundingClientRect();
          maxHeight = Math.max(maxHeight, rect.height);
        });
        if (maxWidth > 0) {
          const clampedWidth = Math.min(Math.ceil(maxWidth), MAX_PLANNING_CELL_WIDTH);
          planningTables.style.setProperty('--planning-cell-width', `${clampedWidth}px`);
        }
        if (maxHeight > 0) {
          const clampedHeight = Math.min(Math.ceil(maxHeight), MAX_PLANNING_CELL_HEIGHT);
          planningTables.style.setProperty('--planning-cell-height', `${clampedHeight}px`);
        }
      };

      const schedulePlanningCellSize = () => {
        if (planningCellSizingFrame) {
          cancelAnimationFrame(planningCellSizingFrame);
        }
        planningCellSizingFrame = requestAnimationFrame(() => {
          planningCellSizingFrame = null;
          measurePlanningCellSize();
        });
      };

      const updatePlanningStickyHeaders = () => {
        if (!planningTables) {
          return;
        }
        const sections = planningTables.querySelectorAll('.planning-month');
        sections.forEach((section) => {
          if (!section.isConnected) {
            return;
          }
          const header = section.querySelector('.planning-month-header');
          const table = section.querySelector('.planning-table');
          if (!header || !table) {
            section.style.removeProperty('--planning-month-header-offset');
            return;
          }
          const headerHeight = header.getBoundingClientRect().height;
          const styles = window.getComputedStyle(section);
          const gapValue = styles.rowGap || styles.gap || '0';
          const gap = Number.parseFloat(gapValue);
          const totalOffset = Math.ceil(headerHeight + (Number.isNaN(gap) ? 0 : gap));
          if (totalOffset > 0) {
            section.style.setProperty('--planning-month-header-offset', `${totalOffset}px`);
          } else {
            section.style.removeProperty('--planning-month-header-offset');
          }
        });
      };

      const schedulePlanningStickyHeaders = () => {
        if (planningStickyHeaderFrame) {
          cancelAnimationFrame(planningStickyHeaderFrame);
        }
        planningStickyHeaderFrame = requestAnimationFrame(() => {
          planningStickyHeaderFrame = null;
          updatePlanningStickyHeaders();
        });
      };

      const slotModal = document.querySelector('#slot-modal');
      const slotModalSubtitle = document.querySelector('#slot-modal-subtitle');
      const slotForm = document.querySelector('#slot-form');
      const slotFeedback = document.querySelector('#slot-feedback');
      const closeSlotModalBtn = document.querySelector('#close-slot-modal');
      const cancelSlotBtn = document.querySelector('#cancel-slot');

      const assignmentModal = document.querySelector('#assignment-modal');
      const assignmentModalSubtitle = document.querySelector('#assignment-modal-subtitle');
      const closeAssignmentModalBtn = document.querySelector('#close-assignment-modal');
      const assignmentForm = document.querySelector('#assignment-form');
      const assignmentSelect = document.querySelector('#assignment-select');
      const assignmentFeedback = document.querySelector('#assignment-feedback');
      const cancelAssignmentBtn = document.querySelector('#cancel-assignment');

      const slotTypeCodeInput = slotForm?.elements['typeCode'];
      if (slotTypeCodeInput) {
        slotTypeCodeInput.addEventListener('input', () => {
          const sanitized = slotTypeCodeInput.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
          slotTypeCodeInput.value = sanitized;
          const mappedCategory = TYPE_CATEGORY_MAP.get(sanitized);
          if (mappedCategory && slotForm.elements['typeCategory']) {
            slotForm.elements['typeCategory'].value = mappedCategory;
          }
        });
      }

      const formatTrigram = (value) => value.replace(/[^a-zA-Z0-9]/g, '').slice(0, 3).toUpperCase();
      trigramInputs.forEach((input) => {
        input.addEventListener('input', () => {
          input.value = formatTrigram(input.value);
        });
      });

      const getUserTrigram = (user) => {
        if (!user) {
          return '';
        }
        const raw = typeof user.trigram === 'string' ? user.trigram.trim() : '';
        if (raw) {
          return raw.toUpperCase();
        }
        if (typeof user.username === 'string' && user.username.length) {
          return user.username.slice(0, 3).toUpperCase();
        }
        return '';
      };

      let editingUser = null;
      let editingSlot = null;
      let usersChannel;
      let planningChannel;
      let allUsers = [];
      let planningSlots = [];
      const planningAssignments = new Map();
      let activeAssignmentButton = null;
      let planningLoading = false;
      let openPlanningConfigMenu = null;
      let planningLoadToken = 0;

      const focusPlanningTourButton = (index) => {
        if (!planningTourTabs) {
          return;
        }
        const button = planningTourTabs.querySelector(`button[data-index="${index}"]`);
        if (button) {
          button.focus();
        }
      };

      const handlePlanningTourKeydown = (event, index, tourId) => {
        const total = PLANNING_TOURS.length;
        if (!total) {
          return;
        }
        switch (event.key) {
          case 'ArrowRight': {
            event.preventDefault();
            focusPlanningTourButton((index + 1) % total);
            break;
          }
          case 'ArrowLeft': {
            event.preventDefault();
            focusPlanningTourButton((index - 1 + total) % total);
            break;
          }
          case 'Home': {
            event.preventDefault();
            focusPlanningTourButton(0);
            break;
          }
          case 'End': {
            event.preventDefault();
            focusPlanningTourButton(total - 1);
            break;
          }
          case ' ':
          case 'Enter': {
            event.preventDefault();
            selectPlanningTour(tourId);
            break;
          }
          default:
            break;
        }
      };

      const renderPlanningTourTabs = () => {
        if (!planningTourTabs) {
          return;
        }
        const activeTour = getTourConfig();
        planningTourTabs.innerHTML = '';
        PLANNING_TOURS.forEach((tour, index) => {
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'planning-tab';
          button.dataset.index = String(index);
          button.id = `planning-tour-${tour.id}`;
          button.setAttribute('role', 'tab');
          button.setAttribute('aria-controls', 'planning-board');
          button.textContent = tour.label;
          const isActive = tour.id === activeTour.id;
          if (isActive) {
            button.classList.add('is-active');
          }
          button.setAttribute('aria-selected', isActive ? 'true' : 'false');
          button.setAttribute('tabindex', isActive ? '0' : '-1');
          button.addEventListener('click', () => {
            selectPlanningTour(tour.id);
          });
          button.addEventListener('keydown', (event) => {
            handlePlanningTourKeydown(event, index, tour.id);
          });
          planningTourTabs.appendChild(button);
        });
      };

      const selectPlanningTour = async (tourId) => {
        if (tourId === selectedTourId) {
          return;
        }
        selectedTourId = tourId;
        planningAssignments.clear();
        cleanupAssignments();
        closePlanningConfigMenu();
        renderPlanningTourTabs();
        if (planningFeedback) {
          planningFeedback.textContent = 'Chargement des colonnes…';
        }
        await subscribeToPlanningChanges();
        loadPlanningColumns(true);
      };

      const sanitizeColor = (value) => {
        if (typeof value !== 'string') {
          return null;
        }
        const trimmed = value.trim();
        if (/^#[0-9a-fA-F]{6}$/.test(trimmed)) {
          return trimmed.toLowerCase();
        }
        if (/^#[0-9a-fA-F]{3}$/.test(trimmed)) {
          const [r, g, b] = trimmed
            .slice(1)
            .split('')
            .map((char) => char + char);
          return `#${r}${g}${b}`.toLowerCase();
        }
        return null;
      };

      const normalizeColor = (value) => sanitizeColor(value) ?? DEFAULT_COLOR;

      const hexToRgb = (value) => {
        const sanitized = sanitizeColor(value);
        if (!sanitized) {
          return null;
        }
        const hex = sanitized.slice(1);
        const numeric = Number.parseInt(hex, 16);
        if (Number.isNaN(numeric)) {
          return null;
        }
        return {
          r: (numeric >> 16) & 255,
          g: (numeric >> 8) & 255,
          b: numeric & 255
        };
      };

      const getSlotColumnTint = (color) => {
        const rgb = hexToRgb(color);
        if (!rgb) {
          return DEFAULT_COLUMN_TINT;
        }
        const alpha = 0.14;
        return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`;
      };

      const getRelativeLuminance = ({ r, g, b }) => {
        const transform = (channel) => {
          const scaled = channel / 255;
          return scaled <= 0.03928 ? scaled / 12.92 : Math.pow((scaled + 0.055) / 1.055, 2.4);
        };
        const red = transform(r);
        const green = transform(g);
        const blue = transform(b);
        return 0.2126 * red + 0.7152 * green + 0.0722 * blue;
      };

      const getSlotTextColor = (color) => {
        const rgb = hexToRgb(color);
        if (!rgb) {
          return '#1f2937';
        }
        const luminance = getRelativeLuminance(rgb);
        return luminance > 0.55 ? '#0f172a' : '#f8fafc';
      };

      const inferTypeCategory = (typeCode) => {
        if (typeof typeCode !== 'string') {
          return 'Visite';
        }
        const normalized = typeCode.trim().toUpperCase();
        return TYPE_CATEGORY_MAP.get(normalized) ?? 'Visite';
      };

      const sanitizeQuality = (value) => (value === 'Bonne' ? 'Bonne' : 'Normale');

      const toBoolean = (value, fallback = true) => {
        if (value === null || value === undefined) {
          return fallback;
        }
        if (typeof value === 'boolean') {
          return value;
        }
        if (typeof value === 'number') {
          return value !== 0;
        }
        const str = String(value).toLowerCase();
        return str === 'true' || str === '1' || str === 'yes' || str === 'oui';
      };

      const formatBoolean = (value) => (value ? 'Oui' : 'Non');

      const getSlotTimeRange = (slot) => {
        const start = (slot.start_time ?? '').trim();
        const end = (slot.end_time ?? '').trim();
        if (start && end) {
          return `${start} – ${end}`;
        }
        if (start) {
          return `Début ${start}`;
        }
        if (end) {
          return `Fin ${end}`;
        }
        return '';
      };

      const selectToBoolean = (value, fallback = true) => {
        if (value === 'true') {
          return true;
        }
        if (value === 'false') {
          return false;
        }
        return fallback;
      };

      const getDefaultSlot = (position) => {
        const defaults = COLUMN_DEFAULTS.find((item) => item.position === position);
        const typeCode = defaults?.typeCode ?? `COL${String(position).padStart(2, '0')}`;
        const category = inferTypeCategory(typeCode);
        return {
          position,
          label: typeCode,
          type_code: typeCode,
          type_category: category,
          start_time: null,
          end_time: null,
          color: defaults?.color ?? DEFAULT_COLOR,
          quality_weekdays: 'Normale',
          quality_saturday: 'Normale',
          quality_sunday: 'Normale',
          open_mauvaise_weekdays: true,
          open_mauvaise_saturday: true,
          open_mauvaise_sunday: true,
          open_bonus_weekdays: true,
          open_bonus_saturday: true,
          open_bonus_sunday: true
        };
      };

      const sortSlotsByPosition = (slots) =>
        [...slots].sort((a, b) => {
          const positionA = Number(a?.position ?? Number.POSITIVE_INFINITY);
          const positionB = Number(b?.position ?? Number.POSITIVE_INFINITY);
          return positionA - positionB;
        });

      const addDays = (date, days) => {
        const clone = new Date(date);
        clone.setDate(clone.getDate() + days);
        return clone;
      };

      const formatDateKey = (date) =>
        `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

      const calculateEaster = (year) => {
        const a = year % 19;
        const b = Math.floor(year / 100);
        const c = year % 100;
        const d = Math.floor(b / 4);
        const e = b % 4;
        const f = Math.floor((b + 8) / 25);
        const g = Math.floor((b - f + 1) / 3);
        const h = (19 * a + b - d - g + 15) % 30;
        const i = Math.floor(c / 4);
        const k = c % 4;
        const l = (32 + 2 * e + 2 * i - h - k) % 7;
        const m = Math.floor((a + 11 * h + 22 * l) / 451);
        const month = Math.floor((h + l - 7 * m + 114) / 31);
        const day = ((h + l - 7 * m + 114) % 31) + 1;
        return new Date(year, month - 1, day);
      };

      const getFrenchHolidays = (year) => {
        const holidays = new Map();
        const addFixed = (month, day, label) => {
          holidays.set(formatDateKey(new Date(year, month, day)), label);
        };
        addFixed(0, 1, "Jour de l'An");
        addFixed(4, 1, 'Fête du Travail');
        addFixed(4, 8, 'Victoire 1945');
        addFixed(6, 14, 'Fête Nationale');
        addFixed(7, 15, 'Assomption');
        addFixed(10, 1, 'Toussaint');
        addFixed(10, 11, 'Armistice');
        addFixed(11, 25, 'Noël');

        const easter = calculateEaster(year);
        holidays.set(formatDateKey(addDays(easter, 1)), 'Lundi de Pâques');
        holidays.set(formatDateKey(addDays(easter, 39)), 'Ascension');
        holidays.set(formatDateKey(addDays(easter, 50)), 'Lundi de Pentecôte');

        return holidays;
      };

      const getMonthDays = (year, month) => {
        const days = [];
        const cursor = new Date(year, month, 1);
        while (cursor.getMonth() === month) {
          days.push(new Date(cursor));
          cursor.setDate(cursor.getDate() + 1);
        }
        return days;
      };

      const getDaySegment = (date, isHoliday) => {
        if (isHoliday || date.getDay() === 0) {
          return 'sunday';
        }
        if (date.getDay() === 6) {
          return 'saturday';
        }
        return 'weekday';
      };

      const getQualityForSegment = (slot, segment) => {
        if (segment === 'saturday') {
          return sanitizeQuality(slot.quality_saturday);
        }
        if (segment === 'sunday') {
          return sanitizeQuality(slot.quality_sunday);
        }
        return sanitizeQuality(slot.quality_weekdays);
      };

      const getSlotOpeningsForSegment = (slot, segment) => {
        const segmentKey = segment === 'saturday' ? 'saturday' : segment === 'sunday' ? 'sunday' : 'weekdays';
        const bonusKey = `open_bonus_${segmentKey}`;
        const mauvaiseKey = `open_mauvaise_${segmentKey}`;
        return {
          bonus: toBoolean(slot[bonusKey]),
          mauvaise: toBoolean(slot[mauvaiseKey])
        };
      };

      const isSlotOpen = (slot, segment, visionOverride = null) => {
        const openings = getSlotOpeningsForSegment(slot, segment);
        if (visionOverride === 'bonus' || visionOverride === 'mauvaise') {
          return openings[visionOverride];
        }
        if (visionOverride === null) {
          return openings.bonus || openings.mauvaise;
        }
        const quality = getQualityForSegment(slot, segment);
        const preferredVision = quality === 'Bonne' ? 'bonus' : 'mauvaise';
        return openings[preferredVision];
      };

      const buildSlotTitle = (slot, dayLabel, isHoliday, holidayName, isOpen, quality) => {
        const details = [];
        const label = slot.label ?? `Créneau ${slot.position}`;
        details.push(label);
        if (slot.type_code) {
          details.push(`Type : ${slot.type_code}`);
        }
        if (slot.type_category) {
          details.push(slot.type_category);
        }
        const slotTime = getSlotTimeRange(slot);
        if (slotTime) {
          details.push(slotTime);
        }
        details.push(`Qualité : ${quality}`);
        details.push(isOpen ? 'Ouvert' : 'Indisponible');
        if (isHoliday && holidayName) {
          details.push(holidayName);
        }
        return `${dayLabel} · ${details.join(' · ')}`;
      };

      const updateAssignmentButton = (button) => {
        if (!button) {
          return;
        }
        const slotKey = button.dataset.slotKey;
        const summary = button.dataset.summary ?? '';
        const srLabel = button.querySelector('.sr-only');
        const tag = button.querySelector('.planning-assignment-tag');
        const roleLabel = button.querySelector('.planning-assignment-role');
        if (!slotKey) {
          schedulePlanningCellSize();
          return;
        }
        const isClosed =
          button.disabled || button.dataset.state === 'closed' || button.getAttribute('aria-disabled') === 'true';
        if (isClosed) {
          if (tag) {
            tag.textContent = '';
            tag.classList.add('is-empty');
          }
          if (roleLabel) {
            roleLabel.textContent = '';
            roleLabel.classList.add('is-empty');
          }
          if (srLabel) {
            srLabel.textContent = summary
              ? `${summary} · Créneau indisponible`
              : 'Créneau indisponible';
          }
          button.title = summary ? `${summary} · Indisponible` : 'Créneau indisponible';
          button.dataset.assignmentUserId = '';
          schedulePlanningCellSize();
          return;
        }
        const assignment = planningAssignments.get(slotKey);
        if (!assignment) {
          if (tag) {
            tag.classList.add('is-empty');
            tag.textContent = '';
          }
          if (roleLabel) {
            roleLabel.textContent = '';
            roleLabel.classList.add('is-empty');
          }
          if (srLabel) {
            srLabel.textContent = summary ? `${summary} · Libre` : 'Créneau libre';
          }
          button.title = summary ? `${summary} · Libre` : 'Créneau libre';
          button.dataset.assignmentUserId = '';
          schedulePlanningCellSize();
          return;
        }
        if (tag) {
          tag.textContent = assignment.trigram;
          tag.classList.remove('is-empty');
        }
        if (roleLabel) {
          const roleText = ASSIGNMENT_ROLE_LABELS[assignment.role] ?? '';
          if (assignment.role === 'medecin' || !roleText) {
            roleLabel.textContent = '';
            roleLabel.classList.add('is-empty');
          } else {
            roleLabel.textContent = roleText;
            roleLabel.classList.remove('is-empty');
          }
        }
        if (srLabel) {
          srLabel.textContent = summary ? `${summary} · ${assignment.trigram}` : assignment.trigram;
        }
        button.title = summary ? `${summary} · ${assignment.trigram}` : assignment.trigram;
        button.dataset.assignmentUserId = String(assignment.id);
        schedulePlanningCellSize();
      };

      const populateAssignmentSelect = (currentUserId) => {
        if (!assignmentSelect) {
          return;
        }
        assignmentSelect.innerHTML = '';
        const noneOption = document.createElement('option');
        noneOption.value = '';
        noneOption.textContent = 'Aucune affectation';
        assignmentSelect.appendChild(noneOption);

        const medecins = allUsers.filter((user) => normalizeRole(user.role) === 'medecin');
        const remplacants = allUsers.filter((user) => normalizeRole(user.role) === 'remplacant');

        const appendGroup = (label, users) => {
          if (!users.length) {
            return;
          }
          const group = document.createElement('optgroup');
          group.label = label;
          users
            .slice()
            .sort((a, b) => getUserTrigram(a).localeCompare(getUserTrigram(b)))
            .forEach((user) => {
              const option = document.createElement('option');
              option.value = String(user.id);
              const trigram = getUserTrigram(user);
              option.textContent = `${trigram} · ${user.username}`;
              group.appendChild(option);
            });
          assignmentSelect.appendChild(group);
        };

        appendGroup('Médecins', medecins);
        appendGroup('Remplaçants', remplacants);

        if (currentUserId) {
          assignmentSelect.value = currentUserId;
          if (assignmentSelect.value !== currentUserId) {
            assignmentSelect.value = '';
          }
        } else {
          assignmentSelect.value = '';
        }

        if (assignmentFeedback) {
          if (medecins.length === 0 && remplacants.length === 0) {
            assignmentFeedback.textContent = 'Aucun médecin ou remplaçant disponible pour le moment.';
          } else {
            assignmentFeedback.textContent = '';
          }
        }
      };

      const refreshAssignmentButtons = () => {
        if (!planningTables) {
          return;
        }
        const buttons = planningTables.querySelectorAll('.planning-slot-toggle');
        buttons.forEach((button) => updateAssignmentButton(button));
        schedulePlanningCellSize();
      };

      const cleanupAssignments = () => {
        const validIds = new Set(allUsers.map((user) => String(user.id)));
        [...planningAssignments.entries()].forEach(([slotKey, assignment]) => {
          if (!validIds.has(String(assignment.id))) {
            planningAssignments.delete(slotKey);
          }
        });
      };

      const closeAssignmentModal = () => {
        activeAssignmentButton = null;
        if (assignmentForm) {
          assignmentForm.reset();
        }
        if (assignmentFeedback) {
          assignmentFeedback.textContent = '';
        }
        assignmentModal?.classList.add('hidden');
      };

      const openAssignmentModal = (button) => {
        if (!assignmentModal || !assignmentForm || !assignmentSelect) {
          return;
        }
        activeAssignmentButton = button;
        const slotKey = button.dataset.slotKey ?? '';
        const summary = button.dataset.summary ?? '';
        if (assignmentForm.elements['slotKey']) {
          assignmentForm.elements['slotKey'].value = slotKey;
        }
        if (assignmentModalSubtitle) {
          assignmentModalSubtitle.textContent = summary;
        }
        const currentUserId = button.dataset.assignmentUserId ?? '';
        populateAssignmentSelect(currentUserId);
        assignmentModal.classList.remove('hidden');
        assignmentSelect.focus();
      };

      const buildPlanningTable = (year, month, holidays) => {
        const table = document.createElement('table');
        table.className = 'planning-table';

        const orderedSlots = sortSlotsByPosition(planningSlots);
        const columnStyles = new Map();
        const columnColors = new Map();

        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const dayHeader = document.createElement('th');
        dayHeader.scope = 'col';
        dayHeader.className = 'planning-day-col';
        dayHeader.textContent = 'Jour';
        headerRow.appendChild(dayHeader);

        orderedSlots.forEach((slot) => {
          const th = document.createElement('th');
          th.scope = 'col';
          const slotColor = normalizeColor(slot.color);
          const slotTextColor = getSlotTextColor(slotColor);
          const columnTint = getSlotColumnTint(slotColor);
          columnStyles.set(slot.position, columnTint);
          columnColors.set(slot.position, { color: slotColor, text: slotTextColor });
          th.style.setProperty('--slot-header-background', columnTint);
          th.style.setProperty('--slot-color', slotColor);
          th.style.setProperty('--slot-text-color', slotTextColor);
          const headerContent = document.createElement('div');
          headerContent.className = 'planning-slot-header';
          const slotNumber = String(slot.position).padStart(2, '0');
          const rawLabel = (slot.label ?? '').trim();
          const slotLabel = rawLabel || `Colonne ${slot.position}`;
          const slotType = slot.type_code ?? '';
          const slotTime = getSlotTimeRange(slot);
          const buttonTitleParts = [slotNumber, slotLabel];
          if (slotType) {
            buttonTitleParts.push(slotType);
          }
          if (slotTime) {
            buttonTitleParts.push(slotTime);
          }
          const buttonTitle = buttonTitleParts.join(' · ');
          const indexBadge = document.createElement('span');
          indexBadge.className = 'planning-slot-index';
          indexBadge.textContent = slotNumber;
          indexBadge.setAttribute('aria-hidden', 'true');
          headerContent.appendChild(indexBadge);
          const button = document.createElement('button');
          button.type = 'button';
          button.dataset.position = String(slot.position);
          button.className = 'planning-slot-button';
          button.style.setProperty('--slot-color', slotColor);
          button.style.setProperty('--slot-text-color', slotTextColor);
          button.title = buttonTitle;
          button.setAttribute('aria-label', buttonTitle);
          const heading = document.createElement('span');
          heading.className = 'planning-slot-heading';
          if (slotType) {
            const typeLabel = document.createElement('span');
            typeLabel.className = 'planning-slot-type';
            typeLabel.textContent = slotType;
            heading.appendChild(typeLabel);
          }
          const titleLabel = document.createElement('span');
          titleLabel.className = 'planning-slot-title';
          titleLabel.textContent = slotLabel;
          heading.appendChild(titleLabel);
          const metaParts = [];
          if (slotTime) {
            metaParts.push(slotTime);
          }
          if (metaParts.length) {
            const metaLabel = document.createElement('span');
            metaLabel.className = 'planning-slot-meta';
            metaLabel.textContent = metaParts.join(' · ');
            heading.appendChild(metaLabel);
          }
          button.appendChild(heading);
          const srLabel = document.createElement('span');
          srLabel.className = 'sr-only';
          srLabel.textContent = buttonTitle;
          button.appendChild(srLabel);
          headerContent.appendChild(button);
          th.appendChild(headerContent);
          headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        const days = getMonthDays(year, month);
        days.forEach((day) => {
          const isoKey = formatDateKey(day);
          const holidayName = holidays?.get(isoKey) ?? null;
          const isHoliday = Boolean(holidayName);
          const row = document.createElement('tr');
          if (isHoliday) {
            row.classList.add('planning-holiday');
          }
          if (day.getDay() === 0) {
            row.classList.add('planning-sunday');
          }

          const dayCell = document.createElement('th');
          dayCell.scope = 'row';
          dayCell.className = 'planning-day-header';
          const dayName = WEEKDAY_LABELS[day.getDay()];
          const dayNumber = String(day.getDate()).padStart(2, '0');
          dayCell.innerHTML = `
            <span class="day-name">${dayName}</span>
            <span class="day-number">${dayNumber} ${MONTH_NAMES[month]}</span>
          `;
          if (holidayName) {
            const badge = document.createElement('span');
            badge.className = 'holiday-badge';
            badge.textContent = holidayName;
            dayCell.appendChild(badge);
          }
          row.appendChild(dayCell);

          orderedSlots.forEach((slot) => {
            const cell = document.createElement('td');
            cell.className = 'planning-summary-cell';
            const columnTint = columnStyles.get(slot.position);
            if (columnTint) {
              cell.style.setProperty('--slot-column-background', columnTint);
            }
            const columnColor = columnColors.get(slot.position);
            const segment = getDaySegment(day, isHoliday);
            const quality = getQualityForSegment(slot, segment);
            const cellVision = quality === 'Bonne' ? 'bonus' : 'mauvaise';
            const openings = getSlotOpeningsForSegment(slot, segment);
            const matchesVision =
              !activePlanningVision ||
              (activePlanningVision === 'bonus' ? openings.bonus : openings.mauvaise);
            cell.dataset.vision = cellVision;
            const open = isSlotOpen(slot, segment, activePlanningVision);

            const summaryTitle = buildSlotTitle(slot, dayName, isHoliday, holidayName, open, quality);
            const slotKey = `${isoKey}:${slot.position}`;

            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'planning-slot-toggle';
            button.dataset.slotKey = slotKey;
            button.dataset.day = isoKey;
            button.dataset.position = String(slot.position);
            button.dataset.summary = summaryTitle;
            if (columnColor) {
              button.style.setProperty('--slot-color', columnColor.color);
              button.style.setProperty('--slot-text-color', columnColor.text);
            }

            if (open) {
              button.dataset.state = 'available';
              button.removeAttribute('aria-disabled');
              button.removeAttribute('tabindex');
            } else {
              button.dataset.state = 'closed';
              button.setAttribute('aria-disabled', 'true');
              button.tabIndex = -1;
            }

            if (!matchesVision) {
              cell.classList.add('is-filtered-out');
              button.setAttribute('aria-hidden', 'true');
              button.tabIndex = -1;
            } else {
              cell.classList.remove('is-filtered-out');
              button.removeAttribute('aria-hidden');
              if (open) {
                button.removeAttribute('tabindex');
              }
            }

            const tag = document.createElement('span');
            tag.className = 'planning-assignment-tag';
            button.appendChild(tag);

            const roleLabel = document.createElement('span');
            roleLabel.className = 'planning-assignment-role';
            button.appendChild(roleLabel);

            const srLabel = document.createElement('span');
            srLabel.className = 'sr-only';
            button.appendChild(srLabel);

            updateAssignmentButton(button);

            cell.appendChild(button);
            row.appendChild(cell);
          });

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        return table;
      };

      const sanitizeActiveTour = (value) => {
        if (value == null || value === '') {
          return null;
        }
        const numeric = Number(value);
        if (!Number.isInteger(numeric)) {
          return null;
        }
        if (numeric < 1 || numeric > PLANNING_TOURS.length) {
          return null;
        }
        return numeric;
      };

      const populatePlanningControls = (defaults = {}) => {
        if (!planningYearSelect || !planningMonthOneSelect || !planningMonthTwoSelect) {
          return;
        }
        const { year, monthOne, monthTwo } = defaults;
        const now = new Date();
        const currentYear = now.getFullYear();
        const years = new Set();
        for (let delta = -2; delta <= 2; delta += 1) {
          years.add(currentYear + delta);
        }
        if (Number.isInteger(year)) {
          years.add(year);
          years.add(year - 1);
          years.add(year + 1);
        }
        const sortedYears = [...years].sort((a, b) => a - b);
        planningYearSelect.innerHTML = sortedYears
          .map((candidate) => `<option value="${candidate}">${candidate}</option>`)
          .join('');
        if (Number.isInteger(year)) {
          planningYearSelect.value = String(year);
        } else {
          planningYearSelect.value = String(currentYear);
        }

        const options = MONTH_NAMES.map((name, index) => `<option value="${index}">${name}</option>`).join('');
        planningMonthOneSelect.innerHTML = options;
        planningMonthTwoSelect.innerHTML = options;

        if (Number.isInteger(monthOne) && monthOne >= 0 && monthOne < MONTH_NAMES.length) {
          planningMonthOneSelect.value = String(monthOne);
        } else {
          planningMonthOneSelect.value = String(now.getMonth());
        }

        if (Number.isInteger(monthTwo) && monthTwo >= 0 && monthTwo < MONTH_NAMES.length) {
          planningMonthTwoSelect.value = String(monthTwo);
        } else {
          planningMonthTwoSelect.value = String((now.getMonth() + 1) % 12);
        }
      };

      const updatePlanningSummary = () => {
        if (planningYearDisplay) {
          const selectedYearOption = planningYearSelect?.selectedOptions?.[0];
          if (selectedYearOption) {
            planningYearDisplay.textContent = selectedYearOption.textContent ?? '—';
          } else {
            planningYearDisplay.textContent = planningYearSelect?.value ?? '—';
          }
        }

        const getMonthLabel = (select) => {
          if (!select) {
            return '—';
          }
          const numeric = Number.parseInt(select.value, 10);
          if (Number.isInteger(numeric) && numeric >= 0 && numeric < MONTH_NAMES.length) {
            return MONTH_NAMES[numeric];
          }
          return '—';
        };

        if (planningMonthOneDisplay) {
          planningMonthOneDisplay.textContent = getMonthLabel(planningMonthOneSelect);
        }
        if (planningMonthTwoDisplay) {
          planningMonthTwoDisplay.textContent = getMonthLabel(planningMonthTwoSelect);
        }
      };

      const applyAdministrativeSettings = (settings, { updateTour = true } = {}) => {
        administrativeSettings = settings ? { ...settings } : null;
        const defaults = {
          year: administrativeSettings?.planning_year ?? null,
          monthOne: administrativeSettings?.planning_month_one ?? null,
          monthTwo: administrativeSettings?.planning_month_two ?? null
        };
        populatePlanningControls(defaults);

        const sanitizedActiveTour = sanitizeActiveTour(administrativeSettings?.active_tour);
        if (activeTourSelect) {
          activeTourSelect.value = sanitizedActiveTour ? String(sanitizedActiveTour) : '';
        }
        if (adminInstructionsField) {
          adminInstructionsField.value = administrativeSettings?.instructions ?? '';
        }

        if (updateTour) {
          if (sanitizedActiveTour) {
            selectedTourId = sanitizedActiveTour;
          } else if (!PLANNING_TOURS.some((tour) => tour.id === selectedTourId)) {
            selectedTourId = PLANNING_TOURS[0].id;
          }
        }

        updatePlanningSummary();
        return { sanitizedActiveTour };
      };

      const fetchAdministrativeSettings = async () => {
        await onSupabaseReady();
        const supabase = getSupabaseClient();
        if (!supabase) {
          return null;
        }
        const { data, error } = await supabase
          .from(ADMIN_SETTINGS_TABLE)
          .select('id, active_tour, instructions, planning_year, planning_month_one, planning_month_two')
          .order('id', { ascending: true })
          .limit(1);
        if (error) {
          console.error(error);
          return null;
        }
        if (!data || data.length === 0) {
          return null;
        }
        return data[0];
      };

      const openAdminSettingsModal = () => {
        if (!adminSettingsModal) {
          return;
        }
        if (adminSettingsFeedback) {
          adminSettingsFeedback.textContent = '';
        }
        applyAdministrativeSettings(administrativeSettings, { updateTour: false });
        adminSettingsModal.classList.remove('hidden');
      };

      const closeAdminSettingsModal = () => {
        if (!adminSettingsModal) {
          return;
        }
        adminSettingsModal.classList.add('hidden');
        if (adminSettingsFeedback) {
          adminSettingsFeedback.textContent = '';
        }
        applyAdministrativeSettings(administrativeSettings, { updateTour: false });
      };

      const renderPlanningConfig = () => {
        if (!planningConfigContainer) {
          return;
        }
        closePlanningConfigMenu();
        if (!planningSlots.length) {
          planningConfigContainer.innerHTML = '<p class="empty-planning">Chargement des colonnes…</p>';
          return;
        }

        planningConfigContainer.innerHTML = '';
        const wrapper = document.createElement('div');
        wrapper.className = 'planning-config-list';

        const table = document.createElement('table');
        table.className = 'table planning-config-table';
        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr>
            <th scope="col">Colonne</th>
            <th scope="col">Type</th>
            <th scope="col">Horaires</th>
            <th scope="col">Couleur</th>
            <th scope="col">Qualités</th>
            <th scope="col">Ouverture Normale</th>
            <th scope="col">Ouverture Bonne</th>
            <th scope="col">Actions</th>
          </tr>
        `;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        const orderedSlots = sortSlotsByPosition(planningSlots);

        orderedSlots.forEach((slot) => {
          const row = document.createElement('tr');

          const colCell = document.createElement('td');
          const posBadge = document.createElement('span');
          posBadge.className = 'planning-config-position';
          posBadge.textContent = String(slot.position).padStart(2, '0');
          colCell.appendChild(posBadge);
          const labelText = (slot.label ?? `Colonne ${slot.position}`).trim();
          const typeText = (slot.type_code ?? '').trim();
          if (labelText && labelText.toLowerCase() !== typeText.toLowerCase()) {
            const name = document.createElement('div');
            name.className = 'planning-config-label';
            name.textContent = labelText;
            colCell.appendChild(name);
          }
          row.appendChild(colCell);

          const typeCell = document.createElement('td');
          const typeCode = document.createElement('div');
          typeCode.className = 'planning-config-type';
          typeCode.textContent = slot.type_code ?? '—';
          typeCell.appendChild(typeCode);
          if (slot.type_category) {
            const category = document.createElement('div');
            category.className = 'planning-config-category';
            category.textContent = slot.type_category;
            typeCell.appendChild(category);
          }
          row.appendChild(typeCell);

          const scheduleCell = document.createElement('td');
          const schedule = getSlotTimeRange(slot);
          scheduleCell.textContent = schedule || '—';
          row.appendChild(scheduleCell);

          const colorCell = document.createElement('td');
          colorCell.className = 'planning-config-color-cell';
          const swatch = document.createElement('span');
          swatch.className = 'planning-config-color';
          swatch.style.backgroundColor = normalizeColor(slot.color);
          swatch.setAttribute('aria-hidden', 'true');
          colorCell.appendChild(swatch);
          const colorValue = document.createElement('span');
          colorValue.className = 'sr-only';
          colorValue.textContent = normalizeColor(slot.color);
          colorCell.appendChild(colorValue);
          colorCell.title = normalizeColor(slot.color);
          row.appendChild(colorCell);

          const qualityCell = document.createElement('td');
          const qualities = [
            { label: 'Lun - Ven', value: slot.quality_weekdays },
            { label: 'Samedi', value: slot.quality_saturday },
            { label: 'Dim / Férié', value: slot.quality_sunday }
          ];
          qualities.forEach(({ label, value }) => {
            const line = document.createElement('div');
            line.className = 'planning-config-line';
            const strong = document.createElement('strong');
            strong.textContent = `${label} : `;
            line.appendChild(strong);
            const text = document.createElement('span');
            text.textContent = value;
            line.appendChild(text);
            qualityCell.appendChild(line);
          });
          row.appendChild(qualityCell);

          const mauvaiseCell = document.createElement('td');
          const mauvaiseStatuses = [
            { label: 'Lun - Ven', value: formatBoolean(slot.open_mauvaise_weekdays) },
            { label: 'Samedi', value: formatBoolean(slot.open_mauvaise_saturday) },
            { label: 'Dim / Férié', value: formatBoolean(slot.open_mauvaise_sunday) }
          ];
          mauvaiseStatuses.forEach(({ label, value }) => {
            const line = document.createElement('div');
            line.className = 'planning-config-line';
            const strong = document.createElement('strong');
            strong.textContent = `${label} : `;
            line.appendChild(strong);
            const text = document.createElement('span');
            text.textContent = value;
            line.appendChild(text);
            mauvaiseCell.appendChild(line);
          });
          row.appendChild(mauvaiseCell);

          const bonusCell = document.createElement('td');
          const bonusStatuses = [
            { label: 'Lun - Ven', value: formatBoolean(slot.open_bonus_weekdays) },
            { label: 'Samedi', value: formatBoolean(slot.open_bonus_saturday) },
            { label: 'Dim / Férié', value: formatBoolean(slot.open_bonus_sunday) }
          ];
          bonusStatuses.forEach(({ label, value }) => {
            const line = document.createElement('div');
            line.className = 'planning-config-line';
            const strong = document.createElement('strong');
            strong.textContent = `${label} : `;
            line.appendChild(strong);
            const text = document.createElement('span');
            text.textContent = value;
            line.appendChild(text);
            bonusCell.appendChild(line);
          });
          row.appendChild(bonusCell);

          const actionCell = document.createElement('td');
          actionCell.className = 'planning-config-actions';
          const menu = document.createElement('div');
          menu.className = 'planning-config-menu';
          const trigger = document.createElement('button');
          trigger.type = 'button';
          trigger.className = 'planning-config-trigger';
          trigger.setAttribute('aria-haspopup', 'true');
          trigger.setAttribute('aria-expanded', 'false');
          trigger.innerHTML = `
            <span aria-hidden="true">⚙️</span>
            <span class="planning-config-trigger-label">Paramètres</span>
          `;
          menu.appendChild(trigger);
          const menuList = document.createElement('div');
          menuList.className = 'planning-config-popover';
          menuList.setAttribute('role', 'menu');
          const editButton = document.createElement('button');
          editButton.type = 'button';
          editButton.className = 'planning-config-edit';
          editButton.dataset.position = slot.position;
          editButton.textContent = 'Configurer la colonne';
          editButton.setAttribute('role', 'menuitem');
          menuList.appendChild(editButton);
          menu.appendChild(menuList);
          actionCell.appendChild(menu);
          row.appendChild(actionCell);

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        wrapper.appendChild(table);
        planningConfigContainer.appendChild(wrapper);
      };

      const closePlanningConfigMenu = () => {
        if (!openPlanningConfigMenu) {
          return;
        }
        openPlanningConfigMenu.classList.remove('is-open');
        const trigger = openPlanningConfigMenu.querySelector('.planning-config-trigger');
        trigger?.setAttribute('aria-expanded', 'false');
        openPlanningConfigMenu = null;
      };

      const renderPlanningTables = () => {
        if (!planningTables) {
          return;
        }
        planningTables.dataset.vision = activePlanningVision ?? 'all';
        if (!planningSlots.length) {
          planningTables.innerHTML = '<p class="empty-planning">Chargement du planning…</p>';
          planningTables.style.removeProperty('--planning-cell-width');
          planningTables.style.removeProperty('--planning-cell-height');
          schedulePlanningStickyHeaders();
          return;
        }
        const baseYear = Number(planningYearSelect?.value ?? new Date().getFullYear());
        const monthOne = Number(planningMonthOneSelect?.value ?? 0);
        const monthTwo = Number(planningMonthTwoSelect?.value ?? 0);

        const selections = [];
        if (!Number.isNaN(monthOne)) {
          selections.push({ month: monthOne, year: baseYear });
        }
        if (!Number.isNaN(monthTwo)) {
          let targetYear = baseYear;
          if (!Number.isNaN(monthOne) && monthTwo < monthOne) {
            targetYear += 1;
          }
          selections.push({ month: monthTwo, year: targetYear });
        }

        const uniqueYears = [...new Set(selections.map((selection) => selection.year))];
        const holidaysByYear = new Map(uniqueYears.map((year) => [year, getFrenchHolidays(year)]));

        planningTables.innerHTML = '';
        selections.forEach((selection) => {
          const monthSection = document.createElement('section');
          monthSection.className = 'planning-month';
          const heading = document.createElement('header');
          heading.className = 'planning-month-header';
          const title = document.createElement('h3');
          title.textContent = `${MONTH_NAMES[selection.month]} ${selection.year}`;
          heading.appendChild(title);
          monthSection.appendChild(heading);
          const table = buildPlanningTable(selection.year, selection.month, holidaysByYear.get(selection.year));
          monthSection.appendChild(table);
          planningTables.appendChild(monthSection);
        });
        schedulePlanningCellSize();
        schedulePlanningStickyHeaders();
      };

      const closeUserModal = () => {
        editingUser = null;
        editForm.reset();
        userModalSubtitle.textContent = '';
        userModal.classList.add('hidden');
      };

      const openUserModal = (user) => {
        editingUser = user;
        const trigram = (user.trigram ?? '').trim() || user.username.slice(0, 3).toUpperCase();
        const canonicalRole = normalizeRole(user.role);
        const roleLabels = {
          administrateur: 'Administrateurs',
          medecin: 'Médecins',
          remplacant: 'Remplaçants'
        };
        const rawRoleLabel = typeof user.originalRole === 'string' && user.originalRole.trim()
          ? user.originalRole.trim()
          : typeof user.role === 'string' && user.role.trim()
            ? user.role.trim()
            : 'Utilisateur';
        const subtitleRole = roleLabels[canonicalRole] ?? rawRoleLabel;
        userModalSubtitle.textContent = `${subtitleRole} · ${user.username}`;
        editForm.elements['id'].value = user.id;
        editForm.elements['username'].value = user.username;
        editForm.elements['trigram'].value = trigram;
        const roleSelect = editForm.elements['role'];
        const nextRole = roleLabels[canonicalRole] ? canonicalRole : 'medecin';
        roleSelect.value = nextRole;
        editForm.elements['password'].value = '';
        userModal.classList.remove('hidden');
        editForm.elements['trigram'].focus();
      };

      const renderUsers = (users) => {
        userGroups.innerHTML = '';

        const roles = [
          { value: 'administrateur', label: 'Administrateurs' },
          { value: 'medecin', label: 'Médecins' },
          { value: 'remplacant', label: 'Remplaçants' }
        ];

        roles.forEach(({ value, label }) => {
          const groupUsers = users.filter((user) => normalizeRole(user.role) === value);
          const section = document.createElement('section');
          section.className = 'user-group';
          section.innerHTML = `
            <header class="user-group-header">
              <h3>${label}</h3>
              <span class="badge">${groupUsers.length}</span>
            </header>
          `;

          const list = document.createElement('div');
          list.className = 'user-grid';

          if (groupUsers.length === 0) {
            const empty = document.createElement('p');
            empty.className = 'empty-group';
            empty.textContent = 'Aucun utilisateur pour le moment.';
            list.appendChild(empty);
          } else {
            [...groupUsers]
              .sort((a, b) => a.trigram.localeCompare(b.trigram))
              .forEach((user) => {
                const trigram = (user.trigram ?? '').trim() || user.username.slice(0, 3).toUpperCase();
                const card = document.createElement('button');
                card.type = 'button';
                card.className = 'user-card';
                card.dataset.id = user.id;
                card.textContent = trigram;
                card.title = `${trigram} · ${user.username}`;
                list.appendChild(card);
              });
          }

          section.appendChild(list);
          userGroups.appendChild(section);
        });

        const unknownUsers = users.filter(
          (user) => !roles.some(({ value }) => normalizeRole(user.role) === value)
        );

        if (unknownUsers.length > 0) {
          const section = document.createElement('section');
          section.className = 'user-group';
          section.innerHTML = `
            <header class="user-group-header">
              <h3>Autres rôles</h3>
              <span class="badge">${unknownUsers.length}</span>
            </header>
          `;

          const list = document.createElement('div');
          list.className = 'user-grid';

          unknownUsers
            .sort((a, b) => a.username.localeCompare(b.username))
            .forEach((user) => {
              const trigram = (user.trigram ?? '').trim() || user.username.slice(0, 3).toUpperCase();
              const card = document.createElement('button');
              card.type = 'button';
              card.className = 'user-card';
              card.dataset.id = user.id;
              const label = typeof user.originalRole === 'string' && user.originalRole.trim()
                ? user.originalRole.trim()
                : typeof user.role === 'string' && user.role.trim()
                  ? user.role.trim()
                  : 'Rôle inconnu';
              card.textContent = trigram;
              card.title = `${trigram} · ${user.username} · ${label}`;
              list.appendChild(card);
            });

          section.appendChild(list);
          userGroups.appendChild(section);
        }
      };

      const loadUsers = async () => {
        await onSupabaseReady();
        const supabase = getSupabaseClient();
        const { data, error } = await supabase
          .from('users')
          .select('id, username, trigram, role')
          .order('username');
        if (error) {
          console.error(error);
          usersFeedback.textContent = "Impossible de récupérer les utilisateurs.";
          return;
        }
        const users = data ?? [];
        allUsers = users.map((user) => {
          const normalizedRole = normalizeRole(user.role);
          const fallbackRole = typeof user.role === 'string' ? user.role.trim() : user.role;
          return {
            ...user,
            role: normalizedRole || fallbackRole,
            originalRole: user.role
          };
        });
        usersFeedback.textContent = `${allUsers.length} utilisateur(s).`;
        renderUsers(allUsers);
        cleanupAssignments();
        refreshAssignmentButtons();
      };

      const ensurePlanningColumns = async (supabase, slots, tableName) => {
        const missing = [];
        for (let position = 1; position <= 46; position += 1) {
          if (!slots.some((slot) => slot.position === position)) {
            missing.push(getDefaultSlot(position));
          }
        }
        if (missing.length === 0) {
          return slots;
        }
        const { error } = await supabase.from(tableName).upsert(missing, { onConflict: 'position' });
        if (error) {
          console.error(error);
          return slots;
        }
        const { data, error: reloadError } = await supabase
          .from(tableName)
          .select(
            `id,
            position,
            label,
            type_code,
            type_category,
            start_time,
            end_time,
            color,
            quality_weekdays,
            quality_saturday,
            quality_sunday,
            open_mauvaise_weekdays,
            open_mauvaise_saturday,
            open_mauvaise_sunday,
            open_bonus_weekdays,
            open_bonus_saturday,
            open_bonus_sunday`
          )
          .order('position');
        if (reloadError) {
          console.error(reloadError);
          return slots;
        }
        return data ?? slots;
      };

      const loadPlanningColumns = async (force = false) => {
        if (planningLoading && !force) {
          return;
        }
        planningLoading = true;
        const requestToken = ++planningLoadToken;
        const tableName = getPlanningTableName();
        if (planningFeedback) {
          planningFeedback.textContent = 'Chargement des colonnes…';
        }
        if (planningTables) {
          planningTables.innerHTML = '<p class="empty-planning">Chargement du planning…</p>';
        }
        if (planningConfigContainer) {
          planningConfigContainer.innerHTML = '<p class="empty-planning">Chargement des colonnes…</p>';
        }
        await onSupabaseReady();
        const supabase = getSupabaseClient();
        const { data, error } = await supabase
          .from(tableName)
          .select(
            `id,
            position,
            label,
            type_code,
            type_category,
            start_time,
            end_time,
            color,
            quality_weekdays,
            quality_saturday,
            quality_sunday,
            open_mauvaise_weekdays,
            open_mauvaise_saturday,
            open_mauvaise_sunday,
            open_bonus_weekdays,
            open_bonus_saturday,
            open_bonus_sunday`
          )
          .order('position');
        if (error) {
          console.error(error);
          if (planningFeedback) {
            planningFeedback.textContent = 'Impossible de charger les colonnes.';
          }
          if (planningTables) {
            planningTables.innerHTML = '<p class="empty-planning">Impossible de charger le planning.</p>';
          }
          if (planningConfigContainer) {
            planningConfigContainer.innerHTML = '<p class="empty-planning">Impossible de charger les colonnes.</p>';
          }
          if (requestToken === planningLoadToken) {
            planningLoading = false;
          }
          return;
        }
        let slots = data ?? [];
        slots = await ensurePlanningColumns(supabase, slots, tableName);
        if (requestToken !== planningLoadToken) {
          return;
        }
        const sortedSlots = sortSlotsByPosition(slots);
        planningSlots = sortedSlots.map((slot) => ({
          ...slot,
          color: normalizeColor(slot.color),
          label: (() => {
            const rawLabel = typeof slot.label === 'string' ? slot.label.trim() : '';
            if (rawLabel) {
              return rawLabel;
            }
            const code = typeof slot.type_code === 'string' ? slot.type_code.trim() : '';
            return code || `Colonne ${slot.position}`;
          })(),
          type_code: ((slot.type_code ?? '').trim().toUpperCase()) || null,
          type_category: (() => {
            const rawCategory = typeof slot.type_category === 'string' ? slot.type_category.trim() : '';
            if (['Visite', 'Consultation', 'Téléconsultation'].includes(rawCategory)) {
              return rawCategory;
            }
            return inferTypeCategory(slot.type_code);
          })(),
          quality_weekdays: sanitizeQuality(slot.quality_weekdays),
          quality_saturday: sanitizeQuality(slot.quality_saturday),
          quality_sunday: sanitizeQuality(slot.quality_sunday),
          open_mauvaise_weekdays: toBoolean(slot.open_mauvaise_weekdays),
          open_mauvaise_saturday: toBoolean(slot.open_mauvaise_saturday),
          open_mauvaise_sunday: toBoolean(slot.open_mauvaise_sunday),
          open_bonus_weekdays: toBoolean(slot.open_bonus_weekdays),
          open_bonus_saturday: toBoolean(slot.open_bonus_saturday),
          open_bonus_sunday: toBoolean(slot.open_bonus_sunday)
        }));
        const total = planningSlots.length;
        if (planningFeedback) {
          planningFeedback.textContent = `${total} colonne${total > 1 ? 's' : ''} configurée${total > 1 ? 's' : ''}.`;
        }
        renderPlanningTables();
        renderPlanningConfig();
        if (requestToken === planningLoadToken) {
          planningLoading = false;
        }
      };

      createForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        await onSupabaseReady();
        const supabase = getSupabaseClient();
        const formData = new FormData(createForm);
        const payload = {
          username: formData.get('username').trim(),
          trigram: formatTrigram(formData.get('trigram') ?? ''),
          password: formData.get('password').trim(),
          role: formData.get('role')
        };

        if (!payload.username || !payload.password || !payload.trigram) {
          createFeedback.textContent = 'Identifiant, trigramme et mot de passe sont obligatoires.';
          return;
        }

        if (payload.trigram.length !== 3) {
          createFeedback.textContent = 'Le trigramme doit contenir exactement 3 caractères.';
          return;
        }

        const { error } = await supabase.from('users').insert(payload);
        if (error) {
          console.error(error);
          createFeedback.textContent = "Impossible de créer l'utilisateur.";
          return;
        }

        createFeedback.textContent = "Utilisateur créé.";
        createForm.reset();
      });

      createForm.addEventListener('input', () => {
        createFeedback.textContent = '';
      });

      userGroups.addEventListener('click', (event) => {
        const card = event.target.closest('.user-card');
        if (!card) {
          return;
        }
        const user = allUsers.find((candidate) => String(candidate.id) === card.dataset.id);
        if (!user) {
          return;
        }
        openUserModal(user);
      });

      closeUserModalBtn.addEventListener('click', closeUserModal);

      userModal.addEventListener('click', (event) => {
        if (event.target === userModal) {
          closeUserModal();
        }
      });

      if (adminSettingsBtn) {
        adminSettingsBtn.addEventListener('click', openAdminSettingsModal);
      }

      if (closeAdminSettingsBtn) {
        closeAdminSettingsBtn.addEventListener('click', closeAdminSettingsModal);
      }

      if (cancelAdminSettingsBtn) {
        cancelAdminSettingsBtn.addEventListener('click', closeAdminSettingsModal);
      }

      if (adminSettingsModal) {
        adminSettingsModal.addEventListener('click', (event) => {
          if (event.target === adminSettingsModal) {
            closeAdminSettingsModal();
          }
        });
      }

      if (adminSettingsForm) {
        adminSettingsForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (adminSettingsFeedback) {
            adminSettingsFeedback.textContent = '';
          }

          await onSupabaseReady();
          const supabase = getSupabaseClient();
          if (!supabase) {
            if (adminSettingsFeedback) {
              adminSettingsFeedback.textContent = 'Connexion à Supabase requise.';
            }
            return;
          }

          const formData = new FormData(adminSettingsForm);
          const activeTourValue = formData.get('activeTour');
          const sanitizedActive = sanitizeActiveTour(activeTourValue);
          const instructionsRaw = formData.get('instructions');
          const trimmedInstructions =
            typeof instructionsRaw === 'string' ? instructionsRaw.trim() : '';
          const parsedYear = Number.parseInt(formData.get('planningYear'), 10);
          const parsedMonthOne = Number.parseInt(formData.get('planningMonthOne'), 10);
          const parsedMonthTwo = Number.parseInt(formData.get('planningMonthTwo'), 10);

          const payload = {
            active_tour: sanitizedActive,
            instructions: trimmedInstructions ? trimmedInstructions : null,
            planning_year: Number.isInteger(parsedYear) ? parsedYear : null,
            planning_month_one:
              Number.isInteger(parsedMonthOne) && parsedMonthOne >= 0 && parsedMonthOne < MONTH_NAMES.length
                ? parsedMonthOne
                : null,
            planning_month_two:
              Number.isInteger(parsedMonthTwo) && parsedMonthTwo >= 0 && parsedMonthTwo < MONTH_NAMES.length
                ? parsedMonthTwo
                : null
          };

          if (adminSettingsRecordId) {
            payload.id = adminSettingsRecordId;
          }

          const { data, error } = await supabase
            .from(ADMIN_SETTINGS_TABLE)
            .upsert(payload, { onConflict: 'id' })
            .select(
              'id, active_tour, instructions, planning_year, planning_month_one, planning_month_two'
            )
            .single();

          if (error) {
            console.error(error);
            if (adminSettingsFeedback) {
              adminSettingsFeedback.textContent = "Impossible d'enregistrer les paramètres.";
            }
            return;
          }

          if (!data) {
            if (adminSettingsFeedback) {
              adminSettingsFeedback.textContent = "Impossible d'enregistrer les paramètres.";
            }
            return;
          }

          adminSettingsRecordId = data.id ?? null;
          const previousTourId = selectedTourId;
          const sanitizedActiveTour = sanitizeActiveTour(data.active_tour);
          if (sanitizedActiveTour && sanitizedActiveTour !== previousTourId) {
            await selectPlanningTour(sanitizedActiveTour);
          }

          applyAdministrativeSettings(data);
          renderPlanningTourTabs();
          renderPlanningTables();

          if (adminSettingsFeedback) {
            adminSettingsFeedback.textContent = 'Paramètres enregistrés.';
          }
        });

        adminSettingsForm.addEventListener('input', () => {
          if (adminSettingsFeedback) {
            adminSettingsFeedback.textContent = '';
          }
        });
      }

      const closeSlotModal = () => {
        editingSlot = null;
        if (slotForm) {
          slotForm.reset();
          if (slotForm.elements['color']) {
            slotForm.elements['color'].value = DEFAULT_COLOR;
          }
          if (slotForm.elements['position']) {
            slotForm.elements['position'].value = '';
          }
        }
        if (slotFeedback) {
          slotFeedback.textContent = '';
        }
        slotModal?.classList.add('hidden');
      };

      const openSlotModal = (slot) => {
        editingSlot = slot;
        if (slotFeedback) {
          slotFeedback.textContent = '';
        }
        const position = slot.position;
        if (slotModalSubtitle) {
          slotModalSubtitle.textContent = `Colonne ${String(position).padStart(2, '0')}`;
        }
        if (!slotForm) {
          return;
        }
        const labelInput = slotForm.elements['label'];
        if (labelInput) {
          labelInput.value = slot.label ?? slot.type_code ?? `Colonne ${position}`;
        }
        const typeCodeInput = slotForm.elements['typeCode'];
        if (typeCodeInput) {
          typeCodeInput.value = (slot.type_code ?? '').toUpperCase();
        }
        const typeCategorySelect = slotForm.elements['typeCategory'];
        if (typeCategorySelect) {
          const normalizedCode = (slot.type_code ?? '').trim().toUpperCase();
          const mapped = TYPE_CATEGORY_MAP.get(normalizedCode) ?? slot.type_category ?? 'Visite';
          typeCategorySelect.value = mapped;
        }
        const startInput = slotForm.elements['startTime'];
        if (startInput) {
          startInput.value = slot.start_time ?? '';
        }
        const endInput = slotForm.elements['endTime'];
        if (endInput) {
          endInput.value = slot.end_time ?? '';
        }
        const colorInput = slotForm.elements['color'];
        if (colorInput) {
          colorInput.value = normalizeColor(slot.color);
        }
        const qualityWeekdays = slotForm.elements['qualityWeekdays'];
        if (qualityWeekdays) {
          qualityWeekdays.value = sanitizeQuality(slot.quality_weekdays);
        }
        const qualitySaturday = slotForm.elements['qualitySaturday'];
        if (qualitySaturday) {
          qualitySaturday.value = sanitizeQuality(slot.quality_saturday);
        }
        const qualitySunday = slotForm.elements['qualitySunday'];
        if (qualitySunday) {
          qualitySunday.value = sanitizeQuality(slot.quality_sunday);
        }
        const openMauvaiseWeekdays = slotForm.elements['openMauvaiseWeekdays'];
        if (openMauvaiseWeekdays) {
          openMauvaiseWeekdays.value = slot.open_mauvaise_weekdays ? 'true' : 'false';
        }
        const openMauvaiseSaturday = slotForm.elements['openMauvaiseSaturday'];
        if (openMauvaiseSaturday) {
          openMauvaiseSaturday.value = slot.open_mauvaise_saturday ? 'true' : 'false';
        }
        const openMauvaiseSunday = slotForm.elements['openMauvaiseSunday'];
        if (openMauvaiseSunday) {
          openMauvaiseSunday.value = slot.open_mauvaise_sunday ? 'true' : 'false';
        }
        const openBonusWeekdays = slotForm.elements['openBonusWeekdays'];
        if (openBonusWeekdays) {
          openBonusWeekdays.value = slot.open_bonus_weekdays ? 'true' : 'false';
        }
        const openBonusSaturday = slotForm.elements['openBonusSaturday'];
        if (openBonusSaturday) {
          openBonusSaturday.value = slot.open_bonus_saturday ? 'true' : 'false';
        }
        const openBonusSunday = slotForm.elements['openBonusSunday'];
        if (openBonusSunday) {
          openBonusSunday.value = slot.open_bonus_sunday ? 'true' : 'false';
        }
        slotForm.elements['position'].value = position;
        slotModal?.classList.remove('hidden');
        labelInput?.focus();
      };

      const handleSlotSubmit = async (event) => {
        event.preventDefault();
        const formData = new FormData(slotForm);
        const position = Number(formData.get('position'));
        if (!position) {
          return;
        }
        const rawLabel = formData.get('label');
        const label = typeof rawLabel === 'string' ? rawLabel.trim() : '';
        const rawTypeCode = formData.get('typeCode');
        const typeCode = typeof rawTypeCode === 'string' ? rawTypeCode.replace(/\s+/g, '').toUpperCase() : '';
        const categoryValue = formData.get('typeCategory');
        const allowedCategories = ['Visite', 'Consultation', 'Téléconsultation'];
        const typeCategory = allowedCategories.includes(categoryValue) ? categoryValue : TYPE_CATEGORY_MAP.get(typeCode) ?? 'Visite';
        const color = normalizeColor(formData.get('color'));
        const qualityWeekdays = sanitizeQuality(formData.get('qualityWeekdays'));
        const qualitySaturday = sanitizeQuality(formData.get('qualitySaturday'));
        const qualitySunday = sanitizeQuality(formData.get('qualitySunday'));
        const openMauvaiseWeekdays = selectToBoolean(formData.get('openMauvaiseWeekdays'), true);
        const openMauvaiseSaturday = selectToBoolean(formData.get('openMauvaiseSaturday'), true);
        const openMauvaiseSunday = selectToBoolean(formData.get('openMauvaiseSunday'), true);
        const openBonusWeekdays = selectToBoolean(formData.get('openBonusWeekdays'), true);
        const openBonusSaturday = selectToBoolean(formData.get('openBonusSaturday'), true);
        const openBonusSunday = selectToBoolean(formData.get('openBonusSunday'), true);
        const startTime = formData.get('startTime') || null;
        const endTime = formData.get('endTime') || null;
        if (slotFeedback) {
          slotFeedback.textContent = 'Enregistrement en cours…';
        }
        await onSupabaseReady();
        const supabase = getSupabaseClient();
        const payload = {
          position,
          label: label || typeCode || `Colonne ${position}`,
          type_code: typeCode || null,
          type_category: typeCategory,
          start_time: startTime && startTime !== '' ? startTime : null,
          end_time: endTime && endTime !== '' ? endTime : null,
          color,
          quality_weekdays: qualityWeekdays,
          quality_saturday: qualitySaturday,
          quality_sunday: qualitySunday,
          open_mauvaise_weekdays: openMauvaiseWeekdays,
          open_mauvaise_saturday: openMauvaiseSaturday,
          open_mauvaise_sunday: openMauvaiseSunday,
          open_bonus_weekdays: openBonusWeekdays,
          open_bonus_saturday: openBonusSaturday,
          open_bonus_sunday: openBonusSunday
        };
        const tableName = getPlanningTableName();
        const { error } = await supabase.from(tableName).upsert(payload, { onConflict: 'position' });
        if (error) {
          console.error(error);
          if (slotFeedback) {
            slotFeedback.textContent = "Impossible d'enregistrer la colonne.";
          }
          return;
        }
        await loadPlanningColumns(true);
        closeSlotModal();
      };

      if (slotModal) {
        slotModal.addEventListener('click', (event) => {
          if (event.target === slotModal) {
            closeSlotModal();
          }
        });
      }

      if (slotForm) {
        slotForm.addEventListener('submit', handleSlotSubmit);
      }

      if (closeSlotModalBtn) {
        closeSlotModalBtn.addEventListener('click', () => {
          closeSlotModal();
        });
      }
      if (cancelSlotBtn) {
        cancelSlotBtn.addEventListener('click', () => {
          closeSlotModal();
        });
      }

      if (assignmentModal) {
        assignmentModal.addEventListener('click', (event) => {
          if (event.target === assignmentModal) {
            closeAssignmentModal();
          }
        });
      }

      if (closeAssignmentModalBtn) {
        closeAssignmentModalBtn.addEventListener('click', () => {
          closeAssignmentModal();
        });
      }

      if (cancelAssignmentBtn) {
        cancelAssignmentBtn.addEventListener('click', () => {
          closeAssignmentModal();
        });
      }

      if (assignmentForm) {
        assignmentForm.addEventListener('submit', (event) => {
          event.preventDefault();
          if (!activeAssignmentButton) {
            closeAssignmentModal();
            return;
          }
          const slotKey = activeAssignmentButton.dataset.slotKey;
          if (!slotKey) {
            closeAssignmentModal();
            return;
          }
          const selectedValue = assignmentSelect?.value ?? '';
          if (!selectedValue) {
            planningAssignments.delete(slotKey);
          } else {
            const user = allUsers.find((candidate) => String(candidate.id) === selectedValue);
            if (!user) {
              if (assignmentFeedback) {
                assignmentFeedback.textContent = 'Utilisateur introuvable.';
              }
              return;
            }
            planningAssignments.set(slotKey, {
              id: user.id,
              trigram: getUserTrigram(user),
              role: user.role,
              username: user.username
            });
          }
          updateAssignmentButton(activeAssignmentButton);
          closeAssignmentModal();
        });
      }

      if (planningTables) {
        planningTables.addEventListener('click', (event) => {
          const toggle = event.target.closest('.planning-slot-toggle');
          if (toggle) {
            if (toggle.dataset.state === 'closed' || toggle.getAttribute('aria-disabled') === 'true') {
              return;
            }
            openAssignmentModal(toggle);
            return;
          }

          const button = event.target.closest('.planning-slot-button');
          if (!button) {
            return;
          }
          const position = Number(button.dataset.position);
          const slot = planningSlots.find((candidate) => candidate.position === position);
          if (slot) {
            openSlotModal(slot);
          }
        });
      }

      window.addEventListener('resize', () => {
        schedulePlanningCellSize();
        schedulePlanningStickyHeaders();
      });

      if (document.fonts && document.fonts.ready && typeof document.fonts.ready.then === 'function') {
        document.fonts.ready
          .then(() => {
            schedulePlanningCellSize();
            schedulePlanningStickyHeaders();
          })
          .catch(() => {
            /* ignore font loading errors for sizing */
          });
      }

      if (planningConfigContainer) {
        planningConfigContainer.addEventListener('click', (event) => {
          const trigger = event.target.closest('.planning-config-trigger');
          if (trigger) {
            const menu = trigger.closest('.planning-config-menu');
            if (!menu) {
              return;
            }
            if (openPlanningConfigMenu && openPlanningConfigMenu !== menu) {
              closePlanningConfigMenu();
            }
            const isOpen = menu.classList.toggle('is-open');
            trigger.setAttribute('aria-expanded', String(isOpen));
            openPlanningConfigMenu = isOpen ? menu : null;
            event.stopPropagation();
            return;
          }

          const button = event.target.closest('.planning-config-edit');
          if (!button) {
            return;
          }
          const position = Number(button.dataset.position);
          const slot = planningSlots.find((candidate) => candidate.position === position);
          closePlanningConfigMenu();
          if (slot) {
            openSlotModal(slot);
          }
        });
      }

      document.addEventListener('click', (event) => {
        if (!event.target.closest('.planning-config-menu')) {
          closePlanningConfigMenu();
        }
      });

      window.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          if (!userModal.classList.contains('hidden')) {
            closeUserModal();
          }
          if (adminSettingsModal && !adminSettingsModal.classList.contains('hidden')) {
            closeAdminSettingsModal();
          }
          if (slotModal && !slotModal.classList.contains('hidden')) {
            closeSlotModal();
          }
          closePlanningConfigMenu();
        }
      });

      editForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!editingUser) {
          return;
        }

        const formData = new FormData(editForm);
        const payload = {
          username: formData.get('username').trim(),
          trigram: formatTrigram(formData.get('trigram') ?? ''),
          role: formData.get('role')
        };
        const password = formData.get('password').trim();

        if (!payload.username || !payload.trigram) {
          alert('Merci de renseigner un identifiant et un trigramme.');
          return;
        }

        if (payload.trigram.length !== 3) {
          alert('Le trigramme doit contenir exactement 3 caractères.');
          return;
        }

        if (password) {
          payload.password = password;
        }

        await onSupabaseReady();
        const supabase = getSupabaseClient();
        const { error } = await supabase.from('users').update(payload).eq('id', editingUser.id);
        if (error) {
          console.error(error);
          alert("Impossible de mettre à jour l'utilisateur.");
          return;
        }

        closeUserModal();
      });

      deleteUserBtn.addEventListener('click', async () => {
        if (!editingUser) {
          return;
        }
        if (!confirm('Supprimer cet utilisateur ?')) {
          return;
        }

        await onSupabaseReady();
        const supabase = getSupabaseClient();
        const { error } = await supabase.from('users').delete().eq('id', editingUser.id);
        if (error) {
          console.error(error);
          alert('Impossible de supprimer cet utilisateur.');
          return;
        }

        closeUserModal();
      });

      const subscribeToUserChanges = async () => {
        await onSupabaseReady();
        const supabase = getSupabaseClient();
        usersChannel = supabase
          .channel('users-changes')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, () => {
            loadUsers();
          })
          .subscribe();
      };

      const subscribeToPlanningChanges = async () => {
        await onSupabaseReady();
        const supabase = getSupabaseClient();
        const tableName = getPlanningTableName();
        if (planningChannel) {
          await planningChannel.unsubscribe();
        }
        planningChannel = supabase
          .channel(`planning-columns-changes-${tableName}`)
          .on('postgres_changes', { event: '*', schema: 'public', table: tableName }, () => {
            loadPlanningColumns(true);
          })
          .subscribe();
      };

      Object.entries(planningVisionButtons).forEach(([vision, button]) => {
        if (!button) {
          return;
        }
        button.addEventListener('click', () => {
          togglePlanningVision(vision);
        });
      });
      updatePlanningVisionButtons();

      const initializeAdminPage = async () => {
        applyAdministrativeSettings(null);

        let settings = null;
        try {
          settings = await fetchAdministrativeSettings();
        } catch (error) {
          console.error(error);
        }

        if (settings) {
          adminSettingsRecordId = settings.id ?? null;
          applyAdministrativeSettings(settings);
        }

        renderPlanningTourTabs();
        renderPlanningTables();

        loadUsers();
        loadPlanningColumns();
        subscribeToUserChanges();
        subscribeToPlanningChanges();
      };

      initializeAdminPage();

      window.addEventListener('beforeunload', () => {
        usersChannel?.unsubscribe();
        planningChannel?.unsubscribe();
      });

    </script>
  </body>
</html>
