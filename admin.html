<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Administration - Gestion des gardes</title>
    <link rel="stylesheet" href="assets/css/styles.css" />
  </head>
  <body>
    <div id="connection-modal" class="modal-backdrop hidden" role="dialog" aria-modal="true">
      <section class="modal">
        <h1>Connexion à Supabase</h1>
        <p>Pour gérer les comptes, configurez l'accès à votre instance Supabase.</p>
        <form id="connection-form" class="card">
          <label for="supabaseUrl">URL Supabase</label>
          <input id="supabaseUrl" name="supabaseUrl" type="url" required />

          <label for="supabaseKey">Clé API</label>
          <input id="supabaseKey" name="supabaseKey" type="password" required />

          <div class="stack" style="justify-content: flex-end;">
            <button type="submit">Se connecter</button>
          </div>
        </form>
      </section>
    </div>

    <main>
      <section class="card admin-shell">
        <header>
          <div>
            <h1>Espace administrateur</h1>
            <p>Gérez les comptes grâce aux trigrammes de vos collaborateurs.</p>
          </div>
          <nav>
            <button id="disconnect" class="secondary" type="button">Changer d'instance</button>
            <button id="logout" class="secondary" type="button">Se déconnecter</button>
          </nav>
        </header>

        <section aria-labelledby="users-title" class="users-section">
          <div class="section-header">
            <h2 id="users-title">Comptes utilisateurs</h2>
            <p id="users-feedback" role="status"></p>
          </div>
          <div class="user-groups" id="user-groups"></div>
        </section>

        <section aria-labelledby="planning-title" class="planning-section">
          <div class="planning-surface">
            <div class="section-header planning-section-header">
              <h2 id="planning-title">Planning des gardes</h2>
              <p id="planning-feedback" role="status"></p>
            </div>

            <nav class="planning-tabs" id="planning-tour-tabs" role="tablist" aria-label="Tours du planning"></nav>

            <form id="planning-controls" class="planning-controls" aria-label="Filtres du planning">
              <div class="planning-control">
                <label for="planning-year">Année</label>
                <select id="planning-year" name="year"></select>
              </div>

              <div class="planning-control">
                <label for="planning-month-1">Mois 1</label>
                <select id="planning-month-1" name="month-1"></select>
              </div>

              <div class="planning-control">
                <label for="planning-month-2">Mois 2</label>
                <select id="planning-month-2" name="month-2"></select>
              </div>
            </form>

            <div class="planning-layout">
              <div class="planning-board" id="planning-board" role="region" aria-labelledby="planning-title">
                <div class="planning-tables" id="planning-tables" aria-live="polite"></div>
              </div>
            </div>
          </div>
        </section>

        <footer class="admin-footer" aria-labelledby="create-title">
          <h2 id="create-title">Ajouter un utilisateur</h2>
          <p>Complétez les informations ci-dessous pour ajouter un nouveau compte.</p>
          <form id="create-user-form" class="compact-form">
            <div class="form-grid">
              <label for="new-username">Identifiant</label>
              <input id="new-username" name="username" type="text" autocomplete="off" required />

              <label for="new-trigram">Trigramme</label>
              <input id="new-trigram" name="trigram" type="text" maxlength="3" autocomplete="off" required class="uppercase-input" />

              <label for="new-password">Mot de passe</label>
              <input id="new-password" name="password" type="password" autocomplete="new-password" required />

              <label for="new-role">Rôle</label>
              <select id="new-role" name="role" required>
                <option value="administrateur">Administrateur</option>
                <option value="medecin">Médecin</option>
                <option value="remplacant">Remplaçant</option>
              </select>
            </div>

            <button type="submit" class="subtle-button">Ajouter l'utilisateur</button>
            <p id="create-feedback" role="status"></p>
          </form>
        </footer>
      </section>
    </main>

    <div id="user-modal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="user-modal-title">
      <section class="modal user-modal">
        <header class="modal-header">
          <div>
            <h2 id="user-modal-title">Gérer l'utilisateur</h2>
            <p id="user-modal-subtitle"></p>
          </div>
          <button type="button" class="icon-button" id="close-user-modal" aria-label="Fermer">&times;</button>
        </header>
        <form id="edit-user-form">
          <input type="hidden" id="edit-user-id" name="id" />

          <label for="edit-username">Identifiant</label>
          <input id="edit-username" name="username" type="text" autocomplete="off" />

          <label for="edit-trigram">Trigramme</label>
          <input id="edit-trigram" name="trigram" type="text" maxlength="3" autocomplete="off" required class="uppercase-input" />

          <label for="edit-role">Rôle</label>
          <select id="edit-role" name="role" required>
            <option value="administrateur">Administrateur</option>
            <option value="medecin">Médecin</option>
            <option value="remplacant">Remplaçant</option>
          </select>

          <label for="edit-password">Nouveau mot de passe</label>
          <input id="edit-password" name="password" type="password" autocomplete="new-password" placeholder="Laisser vide pour ne pas changer" />

          <div class="modal-actions">
            <button type="submit">Enregistrer</button>
            <button type="button" id="delete-user" class="danger">Supprimer</button>
          </div>
        </form>
      </section>
    </div>

    <div id="slot-modal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="slot-modal-title">
      <section class="modal planning-modal">
        <header class="modal-header">
          <div>
            <h2 id="slot-modal-title">Configurer le créneau</h2>
            <p id="slot-modal-subtitle"></p>
          </div>
          <button type="button" class="icon-button" id="close-slot-modal" aria-label="Fermer">&times;</button>
        </header>

        <form id="slot-form">
          <input type="hidden" name="position" id="slot-position" />

          <div class="slot-grid">
            <div class="slot-field-group">
              <label for="slot-label">Nom de la colonne</label>
              <input id="slot-label" name="label" type="text" required />
            </div>

            <div class="slot-field-group">
              <label for="slot-type-code">Type de colonne (acronyme)</label>
              <input id="slot-type-code" name="typeCode" type="text" required />
            </div>

            <div class="slot-field-group">
              <label for="slot-type-category">Catégorie</label>
              <select id="slot-type-category" name="typeCategory" required>
                <option value="Visite">Visite</option>
                <option value="Consultation">Consultation</option>
                <option value="Téléconsultation">Téléconsultation</option>
              </select>
            </div>

            <div class="slot-field-group">
              <label for="slot-color">Couleur</label>
              <input id="slot-color" name="color" type="color" value="#1e293b" />
            </div>
          </div>

          <div class="slot-times">
            <div class="slot-field-group">
              <label for="slot-start">Début</label>
              <input id="slot-start" name="startTime" type="time" />
            </div>
            <div class="slot-field-group">
              <label for="slot-end">Fin</label>
              <input id="slot-end" name="endTime" type="time" />
            </div>
          </div>

          <fieldset class="slot-qualities">
            <legend>Qualité par période</legend>
            <div class="slot-qualities-grid">
              <label for="slot-quality-weekdays">Lun - Ven</label>
              <select id="slot-quality-weekdays" name="qualityWeekdays" required>
                <option value="Mauvaise">Mauvaise</option>
                <option value="Bonus">Bonus</option>
              </select>

              <label for="slot-quality-saturday">Samedi</label>
              <select id="slot-quality-saturday" name="qualitySaturday" required>
                <option value="Mauvaise">Mauvaise</option>
                <option value="Bonus">Bonus</option>
              </select>

              <label for="slot-quality-sunday">Dimanche / Férié</label>
              <select id="slot-quality-sunday" name="qualitySunday" required>
                <option value="Mauvaise">Mauvaise</option>
                <option value="Bonus">Bonus</option>
              </select>
            </div>
          </fieldset>

          <fieldset class="slot-openings">
            <legend>Ouverture des cases</legend>
            <div class="slot-openings-grid">
              <div>
                <h3>Mauvaise</h3>
                <label for="slot-open-mauvaise-weekdays">Lun - Ven</label>
                <select id="slot-open-mauvaise-weekdays" name="openMauvaiseWeekdays" required>
                  <option value="true">Oui</option>
                  <option value="false">Non</option>
                </select>

                <label for="slot-open-mauvaise-saturday">Samedi</label>
                <select id="slot-open-mauvaise-saturday" name="openMauvaiseSaturday" required>
                  <option value="true">Oui</option>
                  <option value="false">Non</option>
                </select>

                <label for="slot-open-mauvaise-sunday">Dimanche / Férié</label>
                <select id="slot-open-mauvaise-sunday" name="openMauvaiseSunday" required>
                  <option value="true">Oui</option>
                  <option value="false">Non</option>
                </select>
              </div>
              <div>
                <h3>Bonus</h3>
                <label for="slot-open-bonus-weekdays">Lun - Ven</label>
                <select id="slot-open-bonus-weekdays" name="openBonusWeekdays" required>
                  <option value="true">Oui</option>
                  <option value="false">Non</option>
                </select>

                <label for="slot-open-bonus-saturday">Samedi</label>
                <select id="slot-open-bonus-saturday" name="openBonusSaturday" required>
                  <option value="true">Oui</option>
                  <option value="false">Non</option>
                </select>

                <label for="slot-open-bonus-sunday">Dimanche / Férié</label>
                <select id="slot-open-bonus-sunday" name="openBonusSunday" required>
                  <option value="true">Oui</option>
                  <option value="false">Non</option>
                </select>
              </div>
            </div>
          </fieldset>

          <div class="modal-actions">
            <button type="submit">Enregistrer</button>
            <button type="button" class="secondary" id="cancel-slot">Annuler</button>
          </div>
          <p id="slot-feedback" role="status"></p>
        </form>
      </section>
    </div>

    <div id="assignment-modal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="assignment-modal-title">
      <section class="modal planning-modal">
        <header class="modal-header">
          <div>
            <h2 id="assignment-modal-title">Attribuer la garde</h2>
            <p id="assignment-modal-subtitle"></p>
          </div>
          <button type="button" class="icon-button" id="close-assignment-modal" aria-label="Fermer">&times;</button>
        </header>

        <form id="assignment-form" class="assignment-form">
          <input type="hidden" name="slotKey" id="assignment-slot-key" />

          <label for="assignment-select">Sélectionner un médecin ou un remplaçant</label>
          <select id="assignment-select" name="userId" class="assignment-select"></select>

          <p id="assignment-feedback" role="status"></p>

          <div class="modal-actions">
            <button type="submit">Enregistrer</button>
            <button type="button" id="cancel-assignment" class="secondary">Annuler</button>
          </div>
        </form>
      </section>
    </div>

    <script type="module">
      import {
        initializeConnectionModal,
        requireRole,
        getCurrentUser,
        setCurrentUser,
        getSupabaseClient,
        onSupabaseReady,
        normalizeRole
      } from './js/supabaseClient.js';

      const DEFAULT_COLOR = '#1e293b';
      const DEFAULT_COLUMN_TINT = 'rgba(30, 41, 59, 0.12)';
      const COLUMN_DEFAULTS = [
        { position: 1, typeCode: '1N', color: '#1e293b' },
        { position: 2, typeCode: '2N', color: '#1e293b' },
        { position: 3, typeCode: '3N', color: '#1e293b' },
        { position: 4, typeCode: '4C', color: '#1e293b' },
        { position: 5, typeCode: '5S', color: '#1e293b' },
        { position: 6, typeCode: '6S', color: '#1e293b' }
      ];

      /* === Correction ici === */
      const TYPE_CATEGORY_MAP = new Map([
        ...['1N','2N','3N','4C','5S','6S','N','C','S','VIS'].map((code) => [code, 'Visite']),
        ...['C1COU','C2COU','C1BOU','C2BOU','PFG','C1ANT','C2ANT','C1','C2','C3'].map((code) => [code, 'Consultation']),
        ...['TC','TCN'].map((code) => [code, 'Téléconsultation'])
      ]);
      /* === fin correction === */

      const PLANNING_TOURS = [
        { id: 1, label: 'Tour 1', table: 'planning_columns' },
        { id: 2, label: 'Tour 2', table: 'planning_columns_tour2' },
        { id: 3, label: 'Tour 3', table: 'planning_columns_tour3' },
        { id: 4, label: 'Tour 4', table: 'planning_columns_tour4' },
        { id: 5, label: 'Tour 5', table: 'planning_columns_tour5' },
        { id: 6, label: 'Tour 6', table: 'planning_columns_tour6' }
      ];

      const currentUser = getCurrentUser();
      if (!currentUser) window.location.replace('index.html');
      requireRole('administrateur');
      initializeConnectionModal();

      document.querySelector('#logout').addEventListener('click', () => {
        setCurrentUser(null);
        window.location.replace('index.html');
      });
    </script>
  </body>
</html>
